<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>pySDC using GPUs &#8212; pySDC 5.6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css?v=2bf1fcf8" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=c40552b6" />
    
    <script src="../_static/documentation_options.js?v=81710850"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="core package" href="../pySDC/core.html" />
    <link rel="prev" title="Exponential SDC for the Monodomain Equation in Cardiac Electrophysiology" href="monodomain.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../pySDC/core.html" title="core package"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="monodomain.html" title="Exponential SDC for the Monodomain Equation in Cardiac Electrophysiology"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 5.6 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pySDC using GPUs</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="pysdc-using-gpus">
<h1>pySDC using GPUs<a class="headerlink" href="#pysdc-using-gpus" title="Link to this heading">¶</a></h1>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Link to this heading">¶</a></h2>
<p>In order to start playing on GPU, install <cite>pySDC</cite> and its dependencies, ideally in developer mode.
First start by setting up a virtual environment, e.g. by using [Miniconda](<a class="reference external" href="https://docs.conda.io/en/latest/miniconda.html">https://docs.conda.io/en/latest/miniconda.html</a>).
Then also add the CuPy Package (the cuda-toolkit will be installed automatically):</p>
<blockquote>
<div><p>conda create -n pySDC
conda activate pySDC
conda install -c conda-forge –file requirements.txt
conda install -c conda-forge cupy</p>
</div></blockquote>
<p>When this is done (and it can take a while), you have your setup to run <cite>pySDC</cite> on the GPU.</p>
</section>
<section id="changes-in-the-problem-classes">
<h2>Changes in the problem_classes<a class="headerlink" href="#changes-in-the-problem-classes" title="Link to this heading">¶</a></h2>
<p>Now you have to change a little bit in the problem_classes. The first and easy step is to change the datatype.
To use pySDC on the GPU with CuPy you must use the [cupy-datatype](../../implementations/datatype_classes/cupy_mesh.py).
The next step is to import cupy in the problem_class. In the following you have to exchange the NumPy/SciPy functions with the CuPy functions.
A [Comparison Table](<a class="reference external" href="https://docs.cupy.dev/en/latest/reference/comparison.html">https://docs.cupy.dev/en/latest/reference/comparison.html</a>) is given from CuPy to do that.
For example: The above steps can be traced using the files
[HeatEquation_ND_FD_forced_periodic.py](../../implementations/problem_classes/HeatEquation_ND_FD_forced_periodic.py)
and [HeatEquation_ND_FD_forced_periodic_gpu.py](../../implementations/problem_classes/HeatEquation_ND_FD_forced_periodic.py)
Now you are ready to run <cite>pySDC</cite> on the GPU.</p>
</section>
<section id="run-pysdc-on-the-gpu">
<h2>Run pySDC on the GPU<a class="headerlink" href="#run-pysdc-on-the-gpu" title="Link to this heading">¶</a></h2>
<p>You have to configure a script to run it. You can see at the file [heat.py](heat.py) that the parameters are the
same for GPU and CPU. Only the import for the problem_class changed.</p>
</section>
<section id="more-examples">
<h2>More examples<a class="headerlink" href="#more-examples" title="Link to this heading">¶</a></h2>
<p>Further examples can found with Allen-Cahn:
* problem: [AllenCahn_2D_FD.py](../../implementations/problem_classes/AllenCahn_2D_FD.py) and [AllenCahn_2D_FD_gpu.py](../../implementations/problem_classes/AllenCahn_2D_FD_gpu.py)
* problem: [AllenCahn_2D_FFT.py](../../implementations/problem_classes/AllenCahn_2D_FFT.py) and [AllenCahn_2D_FFT_gpu.py](../../implementations/problem_classes/AllenCahn_2D_FFT_gpu.py)</p>
<blockquote>
<div><ul class="simple">
<li><p>Script to run pySDC: [ac-fft.py](ac-fft.py)</p></li>
</ul>
</div></blockquote>
</section>
<section id="running-large-problems-on-gpu">
<h2>Running large problems on GPU<a class="headerlink" href="#running-large-problems-on-gpu" title="Link to this heading">¶</a></h2>
<p>This project contains some infrastructure for running and plotting specific problems.
The main file is <cite>run_experiment</cite> and can be configured using command line arguments.
For instance, use</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>srun<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span><span class="w"> </span>python<span class="w"> </span>run_experiment.pyy<span class="w"> </span>--config<span class="o">=</span>GS_USkate<span class="w"> </span>--procs<span class="o">=</span><span class="m">1</span>/1/4<span class="w"> </span>--useGPU<span class="o">=</span>True<span class="w"> </span>--mode<span class="o">=</span>run
mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">8</span><span class="w"> </span>python<span class="w"> </span>run_experiment.py<span class="w"> </span>--config<span class="o">=</span>GS_USkate<span class="w"> </span>--procs<span class="o">=</span><span class="m">1</span>/1/4<span class="w"> </span>--useGPU<span class="o">=</span>True<span class="w"> </span>--mode<span class="o">=</span>plot
python<span class="w"> </span>run_experiment.py<span class="w"> </span>--config<span class="o">=</span>GS_USkate<span class="w"> </span>--procs<span class="o">=</span><span class="m">1</span>/1/4<span class="w"> </span>--useGPU<span class="o">=</span>True<span class="w"> </span>--mode<span class="o">=</span>video
</pre></div>
</div>
<p>to first run the problem, then make plots and then make a video for Gray-Scott with the U-Skate configuration (see arXiv:1501.01990).</p>
<p>To do a parallel scaling test, you can go to JUWELS Booster and use, for instance,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--space_time<span class="o">=</span>True<span class="w"> </span>--XPU<span class="o">=</span>GPU<span class="w"> </span>--problem<span class="o">=</span>GS3D
python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>plot<span class="w"> </span>--space_time<span class="o">=</span>True<span class="w"> </span>--XPU<span class="o">=</span>GPU<span class="w"> </span>--problem<span class="o">=</span>GS3D
</pre></div>
</div>
<p>This will generate jobscripts and submit the jobs. Notice that you have to wait for the jobs to complete before you can plot them.</p>
<p>To learn more about the options for the scripts, run them with <cite>–help</cite>.</p>
</section>
<section id="reproducing-plots-in-thomas-baumann-s-thesis">
<h2>Reproducing plots in Thomas Baumann’s thesis<a class="headerlink" href="#reproducing-plots-in-thomas-baumann-s-thesis" title="Link to this heading">¶</a></h2>
<p>Keep in mind that the results of the experiments are specific to the hardware that was used in the experiments.
To record the data for space-time parallel scaling experiments with Gray-Scott and RBC, run the following commands on the specified machines within the directory that contains this README.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># run on JUWELS</span>
python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>GS3D<span class="w"> </span>--XPU<span class="o">=</span>CPU<span class="w"> </span>--space_time<span class="o">=</span>False
python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>GS3D<span class="w"> </span>--XPU<span class="o">=</span>CPU<span class="w"> </span>--space_time<span class="o">=</span>True

<span class="c1"># run on JUWELS booster</span>
python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>GS3D<span class="w"> </span>--XPU<span class="o">=</span>GPU<span class="w"> </span>--space_time<span class="o">=</span>False
python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>GS3D<span class="w"> </span>--XPU<span class="o">=</span>GPU<span class="w"> </span>--space_time<span class="o">=</span>True

<span class="c1"># run on JURECA DC</span>
python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>RBC<span class="w"> </span>--XPU<span class="o">=</span>CPU<span class="w"> </span>--space_time<span class="o">=</span>False
python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>RBC<span class="w"> </span>--XPU<span class="o">=</span>CPU<span class="w"> </span>--space_time<span class="o">=</span>True

<span class="c1"># run on JUWELS booster</span>
python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>RBC<span class="w"> </span>--XPU<span class="o">=</span>GPU<span class="w"> </span>--space_time<span class="o">=</span>False
python<span class="w"> </span>analysis_scripts/parallel_scaling.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>RBC<span class="w"> </span>--XPU<span class="o">=</span>GPU<span class="w"> </span>--space_time<span class="o">=</span>True
</pre></div>
</div>
<p>These commands will submit a bunch of jobscripts with the individual runs.
Keep in mind that these are specific to a compute project and some paths are account-specific.
Most likely, you will have to change options at the top of the file <cite>./etc/generate_jobscript.py</cite> before you can run anything.
Also, notice that you may not be allowed to request all resources needed for the largest Gray-Scott GPU run during normal operation of JUWELS booster.</p>
<p>After all jobs have run to completion, you have recorded all scaling data and may plot the results with the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>paper_plots.py<span class="w"> </span>--target<span class="o">=</span>thesis
</pre></div>
</div>
<p>In order to run the production runs, modify the <cite>path</cite> class attribute of <cite>LargeSim</cite> in <cite>analysis_scripts/large_simulations.py</cite>.
Then use the following commands on the specified machines:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># run on JUWELS booster</span>
python<span class="w"> </span>analysis_scripts/large_simulations.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>GS<span class="w"> </span>--XPU<span class="o">=</span>GPU

<span class="c1"># run on JURECA DC</span>
python<span class="w"> </span>analysis_scripts/large_simulations.py<span class="w"> </span>--mode<span class="o">=</span>run<span class="w"> </span>--problem<span class="o">=</span>RBC<span class="w"> </span>--XPU<span class="o">=</span>CPU
</pre></div>
</div>
<p>Plotting the results of the Gray-Scott simulation requires a lot of memory and will take very long.
Modify the paths in <cite>analysis_scripts/plot_large_simulations.py</cite> and then run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>analysis_scripts/3d_plot_GS_large.py<span class="w"> </span>--base_path<span class="o">=</span>&lt;path&gt;
python<span class="w"> </span>analysis_scripts/plot_large_simulations.py<span class="w"> </span>--problem<span class="o">=</span>GS
</pre></div>
</div>
<p>Plotting the results of the Rayleigh-Benard production run is more easy.
After modifying the paths as earlier, run the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>analysis_scripts/large_simulations.py<span class="w"> </span>--mode<span class="o">=</span>plot<span class="w"> </span>--problem<span class="o">=</span>RBC<span class="w"> </span>--XPU<span class="o">=</span>CPU
python<span class="w"> </span>analysis_scripts/large_simulations.py<span class="w"> </span>--mode<span class="o">=</span>video<span class="w"> </span>--problem<span class="o">=</span>RBC<span class="w"> </span>--XPU<span class="o">=</span>CPU
python<span class="w"> </span>analysis_scripts/plot_large_simulations.py<span class="w"> </span>--problem<span class="o">=</span>RBC
</pre></div>
</div>
<p>Run scripts with <cite>–help</cite> to learn more about parameters.
Keep in mind that not all features are supported with all problems.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">pySDC using GPUs</a><ul>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#changes-in-the-problem-classes">Changes in the problem_classes</a></li>
<li><a class="reference internal" href="#run-pysdc-on-the-gpu">Run pySDC on the GPU</a></li>
<li><a class="reference internal" href="#more-examples">More examples</a></li>
<li><a class="reference internal" href="#running-large-problems-on-gpu">Running large problems on GPU</a></li>
<li><a class="reference internal" href="#reproducing-plots-in-thomas-baumann-s-thesis">Reproducing plots in Thomas Baumann’s thesis</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="monodomain.html"
                          title="previous chapter">Exponential SDC for the Monodomain Equation in Cardiac Electrophysiology</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../pySDC/core.html"
                          title="next chapter">core package</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/projects/GPU.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../pySDC/core.html" title="core package"
             >next</a> |</li>
        <li class="right" >
          <a href="monodomain.html" title="Exponential SDC for the Monodomain Equation in Cardiac Electrophysiology"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 5.6 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pySDC using GPUs</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Robert Speck.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>