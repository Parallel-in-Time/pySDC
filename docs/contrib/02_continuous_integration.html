<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Continuous Integration in pySDC &#8212; pySDC 5.3.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=89b800e6" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=c40552b6" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=7e71ce01"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pySDC 5.3.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Continuous Integration in pySDC</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="continuous-integration-in-pysdc">
<span id="docs-contrib-02-continuous-integration-continuous-integration-in-pysdc"></span><h1>Continuous Integration in pySDC<a class="headerlink" href="#continuous-integration-in-pysdc" title="Permalink to this heading">¬∂</a></h1>
<p>Any commit in <code class="docutils literal notranslate"><span class="pre">pySDC</span></code> are tested by GitHub continuous integration (CI). You can see in in the <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/actions">action panel</a> the tests for each branches.
Those tests are currently divided in three main categories : <a class="reference internal" href="#docs-contrib-02-continuous-integration-code-linting"><span class="std std-ref">code linting</span></a>, <a class="reference internal" href="#docs-contrib-02-continuous-integration-code-testing"><span class="std std-ref">code testing</span></a> and <a class="reference internal" href="#docs-contrib-02-continuous-integration-code-coverage"><span class="std std-ref">code coverage</span></a>.
Finally, the CI also build artifacts that are used to generate the documentation website (see <a class="reference external" href="http://parallel-in-time.org/pySDC/">http://parallel-in-time.org/pySDC/</a>), more details given in the <a class="reference internal" href="#docs-contrib-02-continuous-integration-documentation-generation"><span class="std std-ref">documentation generation</span></a> section.</p>
<section id="code-linting">
<span id="docs-contrib-02-continuous-integration-code-linting"></span><h2>Code linting<a class="headerlink" href="#code-linting" title="Permalink to this heading">¬∂</a></h2>
<p>Code style linting is performed using <a class="reference external" href="https://black.readthedocs.io/en/stable/">black</a> and <a class="reference external" href="https://flakeheaven.readthedocs.io/en/latest/">flakeheaven</a> for code syntax checking. In particular, <code class="docutils literal notranslate"><span class="pre">black</span></code> is used to check compliance with (most of) <a class="reference external" href="https://peps.python.org/pep-0008/">PEP-8 guidelines</a>.</p>
<p>Those tests are conducted for each commit (even for forks), but you can also run it locally in the root folder of <code class="docutils literal notranslate"><span class="pre">pySDC</span></code> before pushing any commit :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install required packages (works also with conda/mamba)</span>
pip<span class="w"> </span>install<span class="w"> </span>black<span class="w"> </span>flakeheaven<span class="w"> </span>flake8-comprehensions<span class="w"> </span>flake8-bugbear
<span class="c1"># First : test code style linting with black</span>
black<span class="w"> </span>pySDC<span class="w"> </span>--check<span class="w"> </span>--diff<span class="w"> </span>--color
<span class="c1"># Second : test code syntax with flakeheaven</span>
flakeheaven<span class="w"> </span>lint<span class="w"> </span>--benchmark<span class="w"> </span>pySDC
</pre></div>
</div>
<blockquote>
<div><p>üîî To avoid any error about formatting (<code class="docutils literal notranslate"><span class="pre">black</span></code>), you can simply use this program to reformat your code directly using the command :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>black<span class="w"> </span>pySDC
</pre></div>
</div>
</div></blockquote>
<p>Some style rules that are automatically enforced :</p>
<ul class="simple">
<li><p>lines should be not longer than 120 characters</p></li>
<li><p>arithmetic operators (<code class="docutils literal notranslate"><span class="pre">+</span></code>, <code class="docutils literal notranslate"><span class="pre">*</span></code>, ‚Ä¶) should be separated with variables by one empty space</p></li>
</ul>
<p>You can automate linting somewhat by using git hooks.
In order to run black automatically, we want to do a pre-commit hook which adds the modified files to the commit after reformatting.
To this end, just add the following to a possibly new file in the path <code class="docutils literal notranslate"><span class="pre">&lt;pySDC-root-directory&gt;/.git/hooks/pre-commit</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1"># get files that have been staged</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">files</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>diff<span class="w"> </span>--staged<span class="w"> </span>--name-only<span class="w"> </span>HEAD<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>.py<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;s,^,</span><span class="k">$(</span>git<span class="w"> </span>rev-parse<span class="w"> </span>--show-toplevel<span class="k">)</span><span class="s2">/,&quot;</span><span class="k">)</span>

<span class="c1"># remove any deleted files because black will otherwise fail</span>
<span class="k">for</span><span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$files</span>
<span class="k">do</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nv">files</span><span class="o">=(</span><span class="w"> </span><span class="si">${</span><span class="nv">files</span><span class="p">[@]/</span><span class="nv">$file</span><span class="si">}</span><span class="w"> </span><span class="o">)</span>
<span class="w">        </span><span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># apply black and stage the changes that black made</span>
<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$files</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]]</span>
<span class="k">then</span>
<span class="w">        </span>black<span class="w"> </span><span class="nv">$files</span>
<span class="w">        </span>git<span class="w"> </span>add<span class="w"> </span><span class="nv">$files</span>
<span class="k">fi</span>
</pre></div>
</div>
<p>You may need to run <code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">+x</span></code> on the file to allow it to be executed.
Be aware that the hook will alter files you may have opened in an editor whenever you make a commit, which may confuse you(r editor).</p>
<p>To automate flakeheaven, we want to write a hook that alters the commit message in case any errors are detected. This gives us the choice of aborting the commit and fixing the issues, or we can go ahead and commit them and worry about flakeheaven only when the time comes to do a pull request.
To obtain this functionality, add the following to <code class="docutils literal notranslate"><span class="pre">&lt;pySDC-root-directory&gt;/.git/hooks/prepare-commit-msg</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="nv">COMMIT_MSG_FILE</span><span class="o">=</span><span class="nv">$1</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">files</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>diff<span class="w"> </span>--staged<span class="w"> </span>--name-only<span class="w"> </span>HEAD<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>.py<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;s,^,</span><span class="k">$(</span>git<span class="w"> </span>rev-parse<span class="w"> </span>--show-toplevel<span class="k">)</span><span class="s2">/,&quot;</span><span class="k">)</span>

<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$files</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]]</span>
<span class="k">then</span>
<span class="w">        </span><span class="nb">export</span><span class="w"> </span><span class="nv">flakeheaven_output</span><span class="o">=</span><span class="k">$(</span>flakeheaven<span class="w"> </span>lint<span class="w"> </span>--format<span class="w"> </span>default<span class="w"> </span><span class="nv">$files</span><span class="k">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$flakeheaven_output</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span>
<span class="w">        </span><span class="k">then</span>
<span class="w">                </span>git<span class="w"> </span>interpret-trailers<span class="w"> </span>--in-place<span class="w"> </span>--trailer<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$flakeheaven_output</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/^/#/&#39;</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$COMMIT_MSG_FILE</span><span class="s2">&quot;</span>
<span class="w">                </span>git<span class="w"> </span>interpret-trailers<span class="w"> </span>--in-place<span class="w"> </span>--trailer<span class="w"> </span><span class="s2">&quot;#!!!!!!!!!! WARNING: FLAKEHEAVEN FAILED !!!!!!!!!!&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$COMMIT_MSG_FILE</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="k">fi</span>
</pre></div>
</div>
<p>Don‚Äôt forget to assign execution rights.</p>
<p>As a final note, make sure to regularly update linting related packages, as they constantly introduce checking of more PEP8 guidelines.
This might cause the linting to fail in the GitHub action, which uses the most up to date versions available on the conda-forge channel, even though it passed locally.</p>
</section>
<section id="code-testing">
<span id="docs-contrib-02-continuous-integration-code-testing"></span><h2>Code testing<a class="headerlink" href="#code-testing" title="Permalink to this heading">¬∂</a></h2>
<p>This is done using <a class="reference external" href="https://docs.pytest.org/en/7.2.x/">pytest</a>, and runs all the tests written in the <code class="docutils literal notranslate"><span class="pre">pySDC/tests</span></code> folder. You can run those locally in the root folder of <code class="docutils literal notranslate"><span class="pre">pySDC</span></code> using :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install required packages (works also with conda/mamba)</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest&lt;<span class="m">7</span>.2.0<span class="w"> </span>pytest-benchmark<span class="w"> </span>coverage<span class="o">[</span>toml<span class="o">]</span>
<span class="c1"># Run tests</span>
pytest<span class="w"> </span>-v<span class="w"> </span>pySDC/tests
</pre></div>
</div>
<blockquote>
<div><p>üîî Many components are tested (core, implementations, projects, tutorials, etc ‚Ä¶) which make the testing quite long.
When working on a single part of the code, you can run only the corresponding part of the test by specifying the test path, for instance :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>-v<span class="w"> </span>pySDC/tests/test_nodes.py<span class="w">  </span><span class="c1"># only test nodes generation</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="code-coverage">
<span id="docs-contrib-02-continuous-integration-code-coverage"></span><h2>Code coverage<a class="headerlink" href="#code-coverage" title="Permalink to this heading">¬∂</a></h2>
<p>This stage allows to checks how much of the <code class="docutils literal notranslate"><span class="pre">pySDC</span></code> code is tested by the previous stage. It is based on the <a class="reference external" href="https://pypi.org/project/coverage/">coverage</a> library and currently applied to the following directories :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pySDC/core</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pySDC/projects</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pySDC/tutorial</span></code></p></li>
</ul>
<p>This analysis is done in parallel to the test each time a pull is done on any branch (main repository or fork).
You can look at the current coverage report for the master branch <a class="reference external" href="https://parallel-in-time.org/pySDC/coverage/index.html">here</a> or compare the results with previous builds <a class="reference external" href="https://app.codecov.io/gh/Parallel-in-Time/pySDC">here</a>. Codecov will also comment on any pull request, indicating the change of coverage.</p>
<p>During developments, you can also run the coverage tests locally, using :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;print(&#39;Loading sitecustomize.py...&#39;);import coverage;coverage.process_startup()&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>sitecustomize.py
coverage<span class="w"> </span>run<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>--continue-on-collection-errors<span class="w"> </span>-v<span class="w"> </span>--durations<span class="o">=</span><span class="m">0</span><span class="w"> </span>pySDC/tests
</pre></div>
</div>
<blockquote>
<div><p>üîî Note that this will run all <code class="docutils literal notranslate"><span class="pre">pySDC</span></code> tests while analyzing coverage, hence requires all packages installed for the <a class="reference internal" href="#docs-contrib-02-continuous-integration-code-testing"><span class="std std-ref">code testing stage</span></a>.</p>
</div></blockquote>
<p>Once the test are finished, you can collect and post-process coverage result :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>coverage<span class="w"> </span>combine
python<span class="w"> </span>-m<span class="w"> </span>coverage<span class="w"> </span>html
</pre></div>
</div>
<p>This will generate the coverage report in a <code class="docutils literal notranslate"><span class="pre">htmlcov</span></code> folder, and you can open the <code class="docutils literal notranslate"><span class="pre">index.html</span></code> file within using your favorite browser.</p>
<blockquote>
<div><p>‚ö†Ô∏è Coverage can be lower if some tests fails (for instance, if you did not install all required python package to run all the tests).</p>
</div></blockquote>
<section id="coverage-exceptions">
<span id="docs-contrib-02-continuous-integration-coverage-exceptions"></span><h3>Coverage exceptions<a class="headerlink" href="#coverage-exceptions" title="Permalink to this heading">¬∂</a></h3>
<p>Some types of code lines will be ignored by the coverage analysis (<em>e.g</em> lines starting with <code class="docutils literal notranslate"><span class="pre">raise</span></code>, ‚Ä¶), see the <code class="docutils literal notranslate"><span class="pre">[tool.coverage.report]</span></code> section in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>.
Part of code (functions, conditionaly, for loops, etc ‚Ä¶) can be ignored by coverage analysis using the <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">pragma:</span> <span class="pre">no</span> <span class="pre">cover</span></code>, for instance</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="c1"># code analyzed by coverage</span>
<span class="c1"># ...</span>
<span class="k">if</span> <span class="n">condition</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="c1"># code ignored by coverage</span>
<span class="c1"># ...</span>
<span class="c1"># code analyzed by coverage</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">function</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
    <span class="c1"># all function code is ignored by coverage</span>
</pre></div>
</div>
<p>Accepted use of the <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">pragma:</span> <span class="pre">no</span> <span class="pre">cover</span></code> are:</p>
<ol class="arabic simple">
<li><p>Functions and code used for plotting</p></li>
<li><p>Lines in one conditional preceding any <code class="docutils literal notranslate"><span class="pre">raise</span></code> statement</p></li>
</ol>
<p>If you think the pragma should be used in other parts of your pull request, please indicate (and justify) this in your description.</p>
</section>
</section>
<section id="documentation-generation">
<span id="docs-contrib-02-continuous-integration-documentation-generation"></span><h2>Documentation generation<a class="headerlink" href="#documentation-generation" title="Permalink to this heading">¬∂</a></h2>
<p>Documentation is built using <a class="reference external" href="https://www.sphinx-doc.org/en/master/">sphinx</a>.
To check its generation, you can wait for all the CI tasks to download the <code class="docutils literal notranslate"><span class="pre">docs</span></code> artifacts, unzip it and open the <code class="docutils literal notranslate"><span class="pre">index.html</span></code> file there with you favorite browser.</p>
<p>However, when you are working on documentation (of the project, of the code, etc ‚Ä¶), you can already build and check the website locally :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run all tests, continuing even with errors</span>
pytest<span class="w"> </span>--continue-on-collection-errors<span class="w"> </span>-v<span class="w"> </span>--durations<span class="o">=</span><span class="m">0</span><span class="w"> </span>pySDC/tests
<span class="c1"># Generate rst files for sphinx</span>
./docs/update_apidocs.sh
<span class="c1"># Generate html documentation</span>
sphinx-build<span class="w"> </span>-b<span class="w"> </span>html<span class="w"> </span>docs/source<span class="w"> </span>docs/build/html
</pre></div>
</div>
<p>Then you can open <code class="docutils literal notranslate"><span class="pre">docs/build/html/index.html</span></code> using you favorite browser and check how your own documentation looks like on the website.</p>
<blockquote>
<div><p>üîî <strong>Important</strong> : running all the tests is necessary to generate graphs and images used by the website.
But you can still generate the website without it: just all images for the tutorials, projects and playgrounds will be missing.
This approach can be considered for local testing of your contribution when it does not concern parts containing images (<em>i.e</em> project or code documentation).</p>
</div></blockquote>
<p>‚¨ÖÔ∏è <a class="reference internal" href="01_pull_requests.html"><span class="doc">Back to Pull Request Recommendation</span></a> ‚Äî
‚¨ÜÔ∏è <a class="reference internal" href="../../CONTRIBUTING.html"><span class="doc">Contributing Summary</span></a> ‚Äî
‚û°Ô∏è <a class="reference internal" href="03_naming_conventions.html"><span class="doc">Next to Naming Conventions</span></a></p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Continuous Integration in pySDC</a><ul>
<li><a class="reference internal" href="#code-linting">Code linting</a></li>
<li><a class="reference internal" href="#code-testing">Code testing</a></li>
<li><a class="reference internal" href="#code-coverage">Code coverage</a><ul>
<li><a class="reference internal" href="#coverage-exceptions">Coverage exceptions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#documentation-generation">Documentation generation</a></li>
</ul>
</li>
</ul>

  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/docs/contrib/02_continuous_integration.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pySDC 5.3.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Continuous Integration in pySDC</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2023, Robert Speck.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.1.
    </div>
  </body>
</html>