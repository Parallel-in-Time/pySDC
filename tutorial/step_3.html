<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Step-3: Statistics and a new sweeper &#8212; pySDC 5.6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css?v=2bf1fcf8" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=c40552b6" />
    
    <script src="../_static/documentation_options.js?v=81710850"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Step-4: Multilevel SDC" href="step_4.html" />
    <link rel="prev" title="Step-2: Data structures and my first sweeper" href="step_2.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="step_4.html" title="Step-4: Multilevel SDC"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="step_2.html" title="Step-2: Data structures and my first sweeper"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 5.6 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Step-3: Statistics and a new sweeper</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="step-3-statistics-and-a-new-sweeper">
<h1>Step-3: Statistics and a new sweeper<a class="headerlink" href="#step-3-statistics-and-a-new-sweeper" title="Link to this heading">¶</a></h1>
<p>In this step, we will show how to work with the statistics pySDC
generates. We will also introduce a new problem as well as a new
sweeper.</p>
<section id="part-a-getting-statistics">
<h2>Part A: Getting statistics<a class="headerlink" href="#part-a-getting-statistics" title="Link to this heading">¶</a></h2>
<p>In the first part, we run our standard heat equation problem again, but
focus on the <code class="docutils literal notranslate"><span class="pre">stats</span></code> dictionary the controller returns in addition to
the final solution. This <code class="docutils literal notranslate"><span class="pre">stats</span></code> dictionary is a little bit complex,
as its keys are tuples which contain the process, time, level, iteration
and type of entry for the values. This way, each value has some sort of
time stamp attached to it, so that it is clear when this value was
added. To help dealing with the statistics, we make use of the
<code class="docutils literal notranslate"><span class="pre">get_sorted</span></code> routine. This filters the
dictionary, following the keys we provide. Here, we would like to have
all residuals logged during time 0.1 (i.e. for all iterations in the
first time step). Then, it is converted to a list of
tuples, where the first part is the item defined by the parameter
<code class="docutils literal notranslate"><span class="pre">sortby</span></code> and the second part is the value.
Here, we would like to have
a list of iterations and residuals to see how SDC converged over the
iterations.</p>
<p>Important things to note:</p>
<ul class="simple">
<li><p>Here, we use the <code class="docutils literal notranslate"><span class="pre">controller_params</span></code> to control the logging verbosity, see <a class="reference external" href="https://docs.python.org/2/library/logging.html#logging-levels">here</a> for more details.</p></li>
<li><p>Admittedly, the <code class="docutils literal notranslate"><span class="pre">stats</span></code> dictionary is a complex thing, but it
allows users to add other details to it without changing its
definition (see next part).</p></li>
<li><p>For more details on how the entries of <code class="docutils literal notranslate"><span class="pre">stats</span></code> are created, please
check the <code class="docutils literal notranslate"><span class="pre">Hooks</span></code> class.</p></li>
<li><p>We also use the <code class="docutils literal notranslate"><span class="pre">get_list_of_type</span></code> function to show what kind of
values are registered in the statistics. This can be helpful, if
users register their own types, see below.</p></li>
</ul>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/tutorial/step_3/A_getting_statistics.py">pySDC/tutorial/step_3/A_getting_statistics.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.helpers.stats_helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_list_of_types</span><span class="p">,</span> <span class="n">get_sorted</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.controller_classes.controller_nonMPI</span><span class="w"> </span><span class="kn">import</span> <span class="n">controller_nonMPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.problem_classes.HeatEquation_ND_FD</span><span class="w"> </span><span class="kn">import</span> <span class="n">heatNd_forced</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.sweeper_classes.imex_1st_order</span><span class="w"> </span><span class="kn">import</span> <span class="n">imex_1st_order</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple test program to describe how to get statistics of a run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># run simulation</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">()</span>

    <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/step_3_A_out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;List of registered statistic types: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">get_list_of_types</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># filter statistics by first time interval and type (residual)</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;residual_post_iteration&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;iter&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">residuals</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Residual in iteration </span><span class="si">%2i</span><span class="s1">: </span><span class="si">%8.4e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># get and convert filtered statistics to list of iterations count, sorted by time</span>
    <span class="c1"># the get_sorted function is just a shortcut for sort_stats(filter_stats()) with all the same arguments</span>
    <span class="n">iter_counts</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_counts</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Number of iterations at time </span><span class="si">%4.2f</span><span class="s1">: </span><span class="si">%2i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">12</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_counts</span><span class="p">),</span> <span class="p">(</span>
        <span class="s1">&#39;ERROR: number of iterations are not as expected, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">iter_counts</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple test program to run IMEX SDC for a single time step</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;quad_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RADAU-RIGHT&#39;</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># initialize problem parameters</span>
    <span class="n">problem_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># diffusion coefficient</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># frequency for the test value</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1023</span>  <span class="c1"># number of degrees of freedom</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;bc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dirichlet-zero&#39;</span>  <span class="c1"># boundary conditions</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># initialize controller parameters (&lt;-- this is new!)</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># reduce verbosity of each run</span>

    <span class="c1"># Fill description dictionary for easy hierarchy creation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heatNd_forced</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>

    <span class="c1"># instantiate the controller (no controller parameters used here)</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">controller_nonMPI</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="c1"># set time parameters</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="mf">0.9</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

    <span class="c1"># call main function to get things done...</span>
    <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stats</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">List</span> <span class="n">of</span> <span class="n">registered</span> <span class="n">statistic</span> <span class="n">types</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;residual_post_sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;residual_post_iteration&#39;</span><span class="p">,</span> <span class="s1">&#39;niter&#39;</span><span class="p">,</span> <span class="s1">&#39;residual_post_step&#39;</span><span class="p">,</span> <span class="s1">&#39;_recomputed&#39;</span><span class="p">,</span> <span class="s1">&#39;timing_setup&#39;</span><span class="p">,</span> <span class="s1">&#39;timing_comm&#39;</span><span class="p">,</span> <span class="s1">&#39;timing_sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;timing_iteration&#39;</span><span class="p">,</span> <span class="s1">&#39;timing_step&#39;</span><span class="p">,</span> <span class="s1">&#39;timing_run&#39;</span><span class="p">,</span> <span class="s1">&#39;restart&#39;</span><span class="p">]</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span>  <span class="mi">1</span><span class="p">:</span> <span class="mf">4.1119e-03</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span>  <span class="mi">2</span><span class="p">:</span> <span class="mf">6.6844e-04</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span>  <span class="mi">3</span><span class="p">:</span> <span class="mf">8.8038e-05</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span>  <span class="mi">4</span><span class="p">:</span> <span class="mf">1.2171e-05</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span>  <span class="mi">5</span><span class="p">:</span> <span class="mf">1.3827e-06</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span>  <span class="mi">6</span><span class="p">:</span> <span class="mf">6.3645e-07</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span>  <span class="mi">7</span><span class="p">:</span> <span class="mf">1.6895e-07</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span>  <span class="mi">8</span><span class="p">:</span> <span class="mf">3.5260e-08</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span>  <span class="mi">9</span><span class="p">:</span> <span class="mf">6.0725e-09</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span> <span class="mi">10</span><span class="p">:</span> <span class="mf">8.2734e-10</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span> <span class="mi">11</span><span class="p">:</span> <span class="mf">1.1893e-10</span>
<span class="n">Residual</span> <span class="ow">in</span> <span class="n">iteration</span> <span class="mi">12</span><span class="p">:</span> <span class="mf">1.4850e-11</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">0.10</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">0.20</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">0.30</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">0.40</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">0.50</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">0.60</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">0.70</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">0.80</span><span class="p">:</span> <span class="mi">12</span>
</pre></div>
</div>
</section>
<section id="part-b-adding-statistics">
<h2>Part B: Adding statistics<a class="headerlink" href="#part-b-adding-statistics" title="Link to this heading">¶</a></h2>
<p>We now extend the statistics of pySDC by user-defined entries. To make
things much more interesting (and complicated), we introduce a new
problem class (<code class="docutils literal notranslate"><span class="pre">PenningTrap_3D</span></code>) as well a new sweeper
(<code class="docutils literal notranslate"><span class="pre">boris_2nd_order</span></code>). This is accompanied by new data types, namely
<code class="docutils literal notranslate"><span class="pre">particles</span></code> and <code class="docutils literal notranslate"><span class="pre">fields</span></code>. Details on the idea of the Boris solver
for particles moving in electromagnetic fields can be found in <a class="reference external" href="http://dx.doi.org/10.1016/j.jcp.2015.04.022">this
paper</a>. Yet, one
important measure for this kind of problem is the total energy of the
system. We would like to compute this after each time step and
therefore, we define a new hook class called <code class="docutils literal notranslate"><span class="pre">particle_hooks</span></code>. Here,
all necessary computations are done and the value is added to the
statistics for later processing.</p>
<p>Important things to note:</p>
<ul class="simple">
<li><p>In order to extend (and not replace) pySDC’s statistics, make sure
that your custom hook class calls <code class="docutils literal notranslate"><span class="pre">super</span></code> each time a function is
called.</p></li>
<li><p>User-defined statistics can also be used from within the problem
class: simply define a problem attribute (e.g. the number of GMRES
iterations in the spatial solver) and access it during the hook call
using the level.</p></li>
</ul>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/tutorial/step_3/B_adding_statistics.py">pySDC/tutorial/step_3/B_adding_statistics.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.helpers.stats_helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_sorted</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.controller_classes.controller_nonMPI</span><span class="w"> </span><span class="kn">import</span> <span class="n">controller_nonMPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.problem_classes.PenningTrap_3D</span><span class="w"> </span><span class="kn">import</span> <span class="n">penningtrap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.sweeper_classes.boris_2nd_order</span><span class="w"> </span><span class="kn">import</span> <span class="n">boris_2nd_order</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.tutorial.step_3.HookClass_Particles</span><span class="w"> </span><span class="kn">import</span> <span class="n">particle_hook</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple test program to retrieve user-defined statistics from a run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">err</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">run_penning_trap_simulation</span><span class="p">()</span>

    <span class="c1"># filter statistics type (etot)</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;etot&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;iter&#39;</span><span class="p">)</span>

    <span class="c1"># get base energy and show difference</span>
    <span class="n">base_energy</span> <span class="o">=</span> <span class="n">energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/step_3_B_out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">energy</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Total energy and deviation in iteration </span><span class="si">%2i</span><span class="s1">: </span><span class="si">%12.10f</span><span class="s1"> -- </span><span class="si">%12.8e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">base_energy</span> <span class="o">-</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">base_energy</span> <span class="o">-</span> <span class="n">energy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;ERROR: energy deviated too much, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">base_energy</span> <span class="o">-</span> <span class="n">energy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mf">5e-04</span><span class="p">,</span> <span class="s2">&quot;ERROR: solution is not as exact as expected, got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_penning_trap_simulation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple test program to run IMEX SDC for a single time step of the penning trap example</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-08</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">16</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;quad_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RADAU-RIGHT&#39;</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># initialize problem parameters for the Penning trap</span>
    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;omega_E&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.9</span>  <span class="c1"># E-field frequency</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;omega_B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">25.0</span>  <span class="c1"># B-field frequency</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;u0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>  <span class="c1"># initial center of positions</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nparts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># number of particles in the trap</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># smoothing parameter for the forces</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;hook_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particle_hook</span>  <span class="c1"># specialized hook class for more statistics and output</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;log_to_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;data/step_3_B_out.txt&#39;</span>

    <span class="c1"># Fill description dictionary for easy hierarchy creation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">penningtrap</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boris_2nd_order</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>

    <span class="c1"># instantiate the controller (no controller parameters used here)</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">controller_nonMPI</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="c1"># set time parameters</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_init</span><span class="p">()</span>

    <span class="c1"># call main function to get things done...</span>
    <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

    <span class="c1"># compute error compared to know exact solution for one particle</span>
    <span class="n">uex</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">Tend</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">uex</span><span class="o">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">uend</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">uex</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">err</span><span class="p">,</span> <span class="n">stats</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>2025-06-26 06:27:33,482 - controller - controller - welcome_message - 147 - INFO: Welcome to the one and only, really very astonishing and 87.3% bug free
                                 _____ _____   _____ 
                                / ____|  __ \ / ____|
                    _ __  _   _| (___ | |  | | |     
                   | &#39;_ \| | | |\___ \| |  | | |     
                   | |_) | |_| |____) | |__| | |____ 
                   | .__/ \__, |_____/|_____/ \_____|
                   | |     __/ |                     
                   |_|    |___/                      
                                                     
2025-06-26 06:27:33,483 - controller - controller - dump_setup - 161 - INFO: Setup overview (--&gt; user-defined, -&gt; dependency) -- BEGIN
2025-06-26 06:27:33,483 - controller - controller - dump_setup - 228 - INFO: ----------------------------------------------------------------------------------------------------

Controller: &lt;class &#39;pySDC.implementations.controller_classes.controller_nonMPI.controller_nonMPI&#39;&gt;
    all_to_done = False
    dump_setup = True
--&gt; fname = data/step_3_B_out.txt
--&gt; hook_class = [&lt;class &#39;pySDC.implementations.hooks.default_hook.DefaultHooks&#39;&gt;, &lt;class &#39;pySDC.implementations.hooks.log_timings.CPUTimings&#39;&gt;, &lt;class &#39;pySDC.tutorial.step_3.HookClass_Particles.particle_hook&#39;&gt;]
--&gt; log_to_file = True
    logger_level = 20
    mssdc_jac = True
    predict_type = None
    use_iteration_estimator = False

Step: &lt;class &#39;pySDC.core.step.Step&#39;&gt;
--&gt; maxiter = 20
    Number of steps: None
    Level: &lt;class &#39;pySDC.core.level.Level&#39;&gt;
        Level  0
--&gt;         dt = 0.0625
            dt_initial = 0.0625
            nsweeps = 1
            residual_type = full_abs
--&gt;         restol = 1e-08
--&gt;         Problem: &lt;class &#39;pySDC.implementations.problem_classes.PenningTrap_3D.penningtrap&#39;&gt;
--&gt;             nparts = 1
--&gt;             omega_B = 25.0
--&gt;             omega_E = 4.9
--&gt;             sig = 0.1
--&gt;             u0 = [list([10, 0, 0]) list([100, 0, 100]) list([1]) list([1])]
--&gt;             Data type u: &lt;class &#39;pySDC.implementations.datatype_classes.particles.particles&#39;&gt;
--&gt;             Data type f: &lt;class &#39;pySDC.implementations.datatype_classes.particles.fields&#39;&gt;
--&gt;             Sweeper: &lt;class &#39;pySDC.implementations.sweeper_classes.boris_2nd_order.boris_2nd_order&#39;&gt;
                    QE = EE
                    QI = IE
                    do_coll_update = False
                    initial_guess = spread
--&gt;                 num_nodes = 3
--&gt;                 quad_type = RADAU-RIGHT
                    skip_residual_computation = ()
--&gt;                 Collocation: &lt;class &#39;pySDC.core.collocation.CollBase&#39;&gt;

Active convergence controllers:
    |  # | order | convergence controller
----+----+-------+---------------------------------------------------------------------------------------
    |  0 |    95 | BasicRestartingNonMPI
 -&gt; |  1 |   100 | SpreadStepSizesBlockwiseNonMPI
    |  2 |   200 | CheckConvergence

2025-06-26 06:27:33,483 - controller - controller - dump_setup - 231 - INFO: ----------------------------------------------------------------------------------------------------
2025-06-26 06:27:33,483 - controller - controller - dump_setup - 233 - INFO: Setup overview (--&gt; user-defined, -&gt; dependency) -- END

2025-06-26 06:27:36,998 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration:  1 -- Sweep:  1 -- residual: 3.53203678e+00
2025-06-26 06:27:37,003 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration:  2 -- Sweep:  1 -- residual: 2.09852117e-01
2025-06-26 06:27:37,008 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration:  3 -- Sweep:  1 -- residual: 3.50301513e-02
2025-06-26 06:27:37,013 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration:  4 -- Sweep:  1 -- residual: 4.67724741e-03
2025-06-26 06:27:37,018 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration:  5 -- Sweep:  1 -- residual: 7.95583202e-04
2025-06-26 06:27:37,023 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration:  6 -- Sweep:  1 -- residual: 1.11405073e-04
2025-06-26 06:27:37,027 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration:  7 -- Sweep:  1 -- residual: 1.26902403e-05
2025-06-26 06:27:37,032 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration:  8 -- Sweep:  1 -- residual: 1.16534547e-06
2025-06-26 06:27:37,037 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration:  9 -- Sweep:  1 -- residual: 1.66968022e-07
2025-06-26 06:27:37,042 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration: 10 -- Sweep:  1 -- residual: 2.09408171e-08
2025-06-26 06:27:37,046 - hooks - default_hook - post_sweep - 22 - INFO: Process  0 on time 0.000000 at stage         IT_FINE: Level: 0 -- Iteration: 11 -- Sweep:  1 -- residual: 2.17123386e-09
2025-06-26 06:27:37,048 - hooks - log_timings - post_run - 290 - INFO: Finished run after 3.57e+00s
Total energy and deviation in iteration  0: 8799.5000000000 -- 0.00000000e+00
Total energy and deviation in iteration 11: 8785.0038936088 -- 1.44961064e+01
</pre></div>
</div>
</section>
<section id="part-c-studying-collocation-node-types">
<h2>Part C: Studying collocation node types<a class="headerlink" href="#part-c-studying-collocation-node-types" title="Link to this heading">¶</a></h2>
<p>Having first experience with the Boris-SDC solver, we see that the
energy deviates quite a bit already for this simple setup. We now test
this for three different collocation classes to demonstrate how a
parameter study can be done with pySDC. To this end, we describe the
whole setup up to the parameter we would like to vary. Using a simple
list of parameters, we construct the controller each time using a
different collocation class. While slightly inefficient, this makes sure
that the variables and statistics are reset each time.</p>
<p>Important things to note:</p>
<ul class="simple">
<li><p>Interestingly, the energy does not deviate a lot for Gauss-Lobatto
and Gauss-Legendre nodes. This is related to their symmetric nature
(in contrast to Gauss-Radau).</p></li>
<li><p>Using a lower residual tolerance actually improves the energy
conservation even further, at least for symmetric collocation nodes.
Rule of thumb: conservation up to residual tolerance is achieved.</p></li>
<li><p>Working with multiple <code class="docutils literal notranslate"><span class="pre">stats</span></code> dictionaries is not straightforward.
Yet, putting them into a meta-dictionary is useful (as done here).
Alternatively, each <code class="docutils literal notranslate"><span class="pre">stats</span></code> can be processed on the fly and only
the relevant information can be stored.</p></li>
</ul>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/tutorial/step_3/C_study_collocations.py">pySDC/tutorial/step_3/C_study_collocations.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.helpers.stats_helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_sorted</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.controller_classes.controller_nonMPI</span><span class="w"> </span><span class="kn">import</span> <span class="n">controller_nonMPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.problem_classes.PenningTrap_3D</span><span class="w"> </span><span class="kn">import</span> <span class="n">penningtrap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.sweeper_classes.boris_2nd_order</span><span class="w"> </span><span class="kn">import</span> <span class="n">boris_2nd_order</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.tutorial.step_3.HookClass_Particles</span><span class="w"> </span><span class="kn">import</span> <span class="n">particle_hook</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple test program to show the energy deviation for different quadrature nodes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats_dict</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">()</span>

    <span class="n">ediff</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/step_3_C_out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cclass</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">stats_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># filter and convert/sort statistics by etot and iterations</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;etot&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;iter&#39;</span><span class="p">)</span>
        <span class="c1"># compare base and final energy</span>
        <span class="n">base_energy</span> <span class="o">=</span> <span class="n">energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">final_energy</span> <span class="o">=</span> <span class="n">energy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ediff</span><span class="p">[</span><span class="n">cclass</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">base_energy</span> <span class="o">-</span> <span class="n">final_energy</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;Energy deviation for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%12.8e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cclass</span><span class="p">,</span> <span class="n">ediff</span><span class="p">[</span><span class="n">cclass</span><span class="p">])</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># set expected differences and check</span>
    <span class="n">ediff_expect</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">ediff_expect</span><span class="p">[</span><span class="s1">&#39;RADAU-RIGHT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">ediff_expect</span><span class="p">[</span><span class="s1">&#39;LOBATTO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-05</span>
    <span class="n">ediff_expect</span><span class="p">[</span><span class="s1">&#39;GAUSS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3e-05</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ediff</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">ediff_expect</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s2">&quot;ERROR: energy deviated too much, got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ediff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple test program to run IMEX SDC for a single time step</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-06</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">16</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># initialize problem parameters</span>
    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;omega_E&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.9</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;omega_B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">25.0</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;u0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nparts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;hook_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particle_hook</span>  <span class="c1"># specialized hook class for more statistics and output</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># reduce verbosity of each run</span>

    <span class="c1"># Fill description dictionary for easy hierarchy creation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">penningtrap</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boris_2nd_order</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>

    <span class="c1"># assemble and loop over list of collocation classes</span>
    <span class="n">quad_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RADAU-RIGHT&#39;</span><span class="p">,</span> <span class="s1">&#39;GAUSS&#39;</span><span class="p">,</span> <span class="s1">&#39;LOBATTO&#39;</span><span class="p">]</span>
    <span class="n">stats_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">qtype</span> <span class="ow">in</span> <span class="n">quad_types</span><span class="p">:</span>
        <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;quad_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qtype</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>

        <span class="c1"># instantiate the controller (no controller parameters used here)</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">controller_nonMPI</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># set time parameters</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">Tend</span> <span class="o">=</span> <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>

        <span class="c1"># get initial values on finest level</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
        <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_init</span><span class="p">()</span>

        <span class="c1"># call main function to get things done...</span>
        <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

        <span class="c1"># gather stats in dictionary, collocation classes being the keys</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>

    <span class="k">return</span> <span class="n">stats_dict</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Energy</span> <span class="n">deviation</span> <span class="k">for</span> <span class="n">RADAU</span><span class="o">-</span><span class="n">RIGHT</span><span class="p">:</span> <span class="mf">1.44960920e+01</span>
<span class="n">Energy</span> <span class="n">deviation</span> <span class="k">for</span> <span class="n">GAUSS</span><span class="p">:</span> <span class="mf">2.33862938e-05</span>
<span class="n">Energy</span> <span class="n">deviation</span> <span class="k">for</span> <span class="n">LOBATTO</span><span class="p">:</span> <span class="mf">9.32710645e-06</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Step-3: Statistics and a new sweeper</a><ul>
<li><a class="reference internal" href="#part-a-getting-statistics">Part A: Getting statistics</a></li>
<li><a class="reference internal" href="#part-b-adding-statistics">Part B: Adding statistics</a></li>
<li><a class="reference internal" href="#part-c-studying-collocation-node-types">Part C: Studying collocation node types</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="step_2.html"
                          title="previous chapter">Step-2: Data structures and my first sweeper</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="step_4.html"
                          title="next chapter">Step-4: Multilevel SDC</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorial/step_3.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="step_4.html" title="Step-4: Multilevel SDC"
             >next</a> |</li>
        <li class="right" >
          <a href="step_2.html" title="Step-2: Data structures and my first sweeper"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 5.6 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Step-3: Statistics and a new sweeper</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Robert Speck.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>