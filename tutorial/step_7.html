<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Step-7: pySDC with external libraries &#8212; pySDC 5.5.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css?v=def86cc0" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=c40552b6" />
    
    <script src="../_static/documentation_options.js?v=a385a3de"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Step-8: Advanced topics" href="step_8.html" />
    <link rel="prev" title="Step-6: Advanced PFASST controllers" href="step_6.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="step_8.html" title="Step-8: Advanced topics"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="step_6.html" title="Step-6: Advanced PFASST controllers"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 5.5.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Step-7: pySDC with external libraries</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="step-7-pysdc-with-external-libraries">
<h1>Step-7: pySDC with external libraries<a class="headerlink" href="#step-7-pysdc-with-external-libraries" title="Link to this heading">¶</a></h1>
<p>pySDC can be used with external libraries, in particular for spatial discretization, parallelization and solving of linear and/or nonlinear systems.
In the following, we show a few examples of pySDC + X.</p>
<section id="part-a-pysdc-and-fenics">
<h2>Part A: pySDC and FEniCS<a class="headerlink" href="#part-a-pysdc-and-fenics" title="Link to this heading">¶</a></h2>
<p>In this example, pySDC is coupled with the <a class="reference external" href="https://fenicsproject.org/">FEniCS framework</a> for using finite elements in space.
This implies significant changes to the algorithm, depending on whether or not the mass matrix should be inverted.
SDC, MLSDC and PFASST can be used without changes when the right-hand side of the ODE is defined with the inverse of the mass matrix.
Otherwise, the mass matrix has to be used for e.g. the tau-correction.
This example tests different variants of this methodology for SDC, MLSDC and PFASST.</p>
<p>Important things to note:</p>
<ul class="simple">
<li><p>This example shows that even core routines like the <cite>BaseTransfer</cite> can be overwritten if needed.</p></li>
<li><p>It is also valuable to check out the data type and transfer classes required to work with FEniCS. Both can be found in the <cite>implementations</cite> folder.</p></li>
</ul>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/tutorial/step_7/A_pySDC_with_FEniCS.py">pySDC/tutorial/step_7/A_pySDC_with_FEniCS.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pySDC.helpers.stats_helper</span> <span class="kn">import</span> <span class="n">get_sorted</span>

<span class="kn">from</span> <span class="nn">pySDC.implementations.controller_classes.controller_nonMPI</span> <span class="kn">import</span> <span class="n">controller_nonMPI</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.HeatEquation_1D_FEniCS_matrix_forced</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">fenics_heat_mass</span><span class="p">,</span>
    <span class="n">fenics_heat</span><span class="p">,</span>
    <span class="n">fenics_heat_mass_timebc</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.imex_1st_order_mass</span> <span class="kn">import</span> <span class="n">imex_1st_order_mass</span><span class="p">,</span> <span class="n">imex_1st_order</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.transfer_classes.TransferFenicsMesh</span> <span class="kn">import</span> <span class="n">mesh_to_mesh_fenics</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">t0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper routine to set up parameters</span>

<span class="sd">    Args:</span>
<span class="sd">        t0 (float): initial time</span>
<span class="sd">        ml (bool): use single or multiple levels</span>

<span class="sd">    Returns:</span>
<span class="sd">        description and controller_params parameter dictionaries</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5e-10</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;quad_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RADAU-RIGHT&#39;</span>
    <span class="k">if</span> <span class="n">ml</span><span class="p">:</span>
        <span class="c1"># Note that coarsening in the nodes actually HELPS MLSDC to converge (M=1 is exact on the coarse level)</span>
        <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span>  <span class="c1"># ugly, but necessary to set up this ProblemClass</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;c_nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CG&#39;</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">ml</span><span class="p">:</span>
        <span class="c1"># We can do rather aggressive coarsening here. As long as we have 1 node on the coarse level, all is &quot;well&quot; (ie.</span>
        <span class="c1"># MLSDC does not take more iterations than SDC, but also not less). If we just coarsen in the refinement (and</span>
        <span class="c1"># not in the nodes and order, the mass inverse approach is way better, ie. halves the number of iterations!</span>
        <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;refinements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;refinements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="n">base_transfer_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">base_transfer_params</span><span class="p">[</span><span class="s1">&#39;finter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Fill description dictionary for easy hierarchy creation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_to_mesh_fenics</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;base_transfer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_transfer_params</span>

    <span class="k">return</span> <span class="n">description</span><span class="p">,</span> <span class="n">controller_params</span>


<span class="k">def</span> <span class="nf">run_variants</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main routine to run the different implementations of the heat equation with FEniCS</span>

<span class="sd">    Args:</span>
<span class="sd">        variant (str): specifies the variant</span>
<span class="sd">        ml (bool): use single or multiple levels</span>
<span class="sd">        num_procs (int): number of processors in time</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">description</span><span class="p">,</span> <span class="n">controller_params</span> <span class="o">=</span> <span class="n">setup</span><span class="p">(</span><span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="n">ml</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>
        <span class="c1"># Note that we need to reduce the tolerance for the residual here, since otherwise the error will be too high</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">][</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">500</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fenics_heat_mass</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order_mass</span>
    <span class="k">elif</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;mass_inv&#39;</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fenics_heat</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>
    <span class="k">elif</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;mass_timebc&#39;</span><span class="p">:</span>
        <span class="c1"># Can increase the tolerance here, errors are higher anyway</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">][</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">20</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fenics_heat_mass_timebc</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order_mass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Variant </span><span class="si">%s</span><span class="s1"> is not implemented&#39;</span> <span class="o">%</span> <span class="n">variant</span><span class="p">)</span>

    <span class="c1"># quickly generate block of steps</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">controller_nonMPI</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span> <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># call main function to get things done...</span>
    <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

    <span class="c1"># compute exact solution and compare</span>
    <span class="n">uex</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">Tend</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">uex</span> <span class="o">-</span> <span class="n">uend</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">uex</span><span class="p">)</span>

    <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/step_7_A_out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Variant </span><span class="si">{</span><span class="n">variant</span><span class="si">}</span><span class="s1"> with ml=</span><span class="si">{</span><span class="n">ml</span><span class="si">}</span><span class="s1"> and num_procs=</span><span class="si">{</span><span class="n">num_procs</span><span class="si">}</span><span class="s1"> -- error at time </span><span class="si">{</span><span class="n">Tend</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># filter statistics by type (number of iterations)</span>
    <span class="n">iter_counts</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="n">niters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_counts</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Mean number of iterations: </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Range of values for number of iterations: </span><span class="si">%2i</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Position of max/min number of iterations: </span><span class="si">%2i</span><span class="s1"> -- </span><span class="si">%2i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Std and var for number of iterations: </span><span class="si">%4.2f</span><span class="s1"> -- </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="n">timing</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;timing_run&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Time to solution: </span><span class="si">{</span><span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">6.4f</span><span class="si">}</span><span class="s1"> sec.&#39;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_procs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">6.0</span><span class="p">,</span> <span class="s1">&#39;Mean number of iterations is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span> <span class="ow">or</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;mass_inv&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="mf">1.14e-08</span><span class="p">,</span> <span class="s1">&#39;Error is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="mf">3.25e-07</span><span class="p">,</span> <span class="s1">&#39;Error is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">11.6</span><span class="p">,</span> <span class="s1">&#39;Mean number of iterations is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="mf">1.14e-08</span><span class="p">,</span> <span class="s1">&#39;Error is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">run_variants</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="s1">&#39;mass_inv&#39;</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_variants</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_variants</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="s1">&#39;mass_timebc&#39;</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_variants</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="s1">&#39;mass_inv&#39;</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_variants</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_variants</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="s1">&#39;mass_timebc&#39;</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_variants</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="s1">&#39;mass_inv&#39;</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># WARNING: all other variants do NOT work, either because of FEniCS restrictions (weak forms with different meshes</span>
    <span class="c1"># will not work together) or because of inconsistent use of the mass matrix (locality condition for the tau</span>
    <span class="c1"># correction is not satisfied, mass matrix does not permute with restriction).</span>
    <span class="c1"># run_pfasst_variants(variant=&#39;mass&#39;, ml=True, num_procs=5)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Variant</span> <span class="n">mass_inv</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span> <span class="n">error</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">1.0</span><span class="p">:</span> <span class="mf">1.1387407230222816e-08</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">6.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">0.00</span> <span class="o">--</span> <span class="mf">0.00</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.7049</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Variant</span> <span class="n">mass</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span> <span class="n">error</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">1.0</span><span class="p">:</span> <span class="mf">1.1387594756569534e-08</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">6.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">0.00</span> <span class="o">--</span> <span class="mf">0.00</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.2785</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Variant</span> <span class="n">mass_timebc</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span> <span class="n">error</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">1.0</span><span class="p">:</span> <span class="mf">3.2473562155116167e-07</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">6.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">3</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">3</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">1.10</span> <span class="o">--</span> <span class="mf">1.20</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.2860</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Variant</span> <span class="n">mass_inv</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span> <span class="n">error</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">1.0</span><span class="p">:</span> <span class="mf">1.138768636885694e-08</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">6.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">0.00</span> <span class="o">--</span> <span class="mf">0.00</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">2.3525</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Variant</span> <span class="n">mass</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span> <span class="n">error</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">1.0</span><span class="p">:</span> <span class="mf">1.1387216566052821e-08</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">6.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">0.00</span> <span class="o">--</span> <span class="mf">0.00</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">2.0106</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Variant</span> <span class="n">mass_timebc</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span> <span class="n">error</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">1.0</span><span class="p">:</span> <span class="mf">3.2473561574763597e-07</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">6.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">3</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">3</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">1.10</span> <span class="o">--</span> <span class="mf">1.20</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">2.0254</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Variant</span> <span class="n">mass_inv</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">5</span> <span class="o">--</span> <span class="n">error</span> <span class="n">at</span> <span class="n">time</span> <span class="mf">1.0</span><span class="p">:</span> <span class="mf">1.1150087179536389e-08</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">11.60</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">9</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">4</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">3.26</span> <span class="o">--</span> <span class="mf">10.64</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">3.9155</span> <span class="n">sec</span><span class="o">.</span>

</pre></div>
</div>
</section>
<section id="part-b-mpi4py-fft-for-parallel-fourier-transforms">
<h2>Part B: mpi4py-fft for parallel Fourier transforms<a class="headerlink" href="#part-b-mpi4py-fft-for-parallel-fourier-transforms" title="Link to this heading">¶</a></h2>
<p>The most prominent parallel solver is, probably, the FFT.
While many implementations or wrappers for Python exist, we decided to use <a class="reference external" href="https://mpi4py-fft.readthedocs.io/en/latest/">mpi4py-fft</a>, which provided the easiest installation, a simple API and good parallel scaling.
As an example, we here test the nonlinear Schrödinger equation, using the IMEX sweeper to treat the nonlinear parts explicitly.
The code allows to work both in real and spectral space, while the latter is usually faster.
This example tests SDC, MLSDC and PFASST.</p>
<p>Important things to note:</p>
<ul class="simple">
<li><p>The code runs both in serial using just <cite>python B_pySDC_with_mpi4pyfft.py</cite> and also in parallel using <cite>mpirun -np 2 python B_pySDC_with_mpi4pyfft.py</cite>.</p></li>
<li><p>The nonlinear Schrödinger example is not expected to work well with PFASST. In fact, SDC and MLSDC converge for larger time-steps, but PFASST does not.</p></li>
</ul>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/tutorial/step_7/B_pySDC_with_mpi4pyfft.py">pySDC/tutorial/step_7/B_pySDC_with_mpi4pyfft.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>

<span class="kn">from</span> <span class="nn">pySDC.helpers.stats_helper</span> <span class="kn">import</span> <span class="n">get_sorted</span>

<span class="kn">from</span> <span class="nn">pySDC.implementations.controller_classes.controller_nonMPI</span> <span class="kn">import</span> <span class="n">controller_nonMPI</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.imex_1st_order</span> <span class="kn">import</span> <span class="n">imex_1st_order</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.NonlinearSchroedinger_MPIFFT</span> <span class="kn">import</span> <span class="n">nonlinearschroedinger_imex</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.transfer_classes.TransferMesh_MPIFFT</span> <span class="kn">import</span> <span class="n">fft_to_fft</span>


<span class="k">def</span> <span class="nf">run_simulation</span><span class="p">(</span><span class="n">spectral</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A test program to do SDC, MLSDC and PFASST runs for the 2D NLS equation</span>

<span class="sd">    Args:</span>
<span class="sd">        spectral (bool): run in real or spectral space</span>
<span class="sd">        ml (bool): single or multiple levels</span>
<span class="sd">        num_procs (int): number of parallel processors</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>

    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-08</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-01</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;nsweeps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;quad_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RADAU-RIGHT&#39;</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LU&#39;</span><span class="p">]</span>  <span class="c1"># For the IMEX sweeper, the LU-trick can be activated for the implicit part</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;initial_guess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;zero&#39;</span>

    <span class="c1"># initialize problem parameters</span>
    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ml</span><span class="p">:</span>
        <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;spectral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectral</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comm</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span> <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">99</span>
    <span class="c1"># controller_params[&#39;predict_type&#39;] = &#39;fine_only&#39;</span>

    <span class="c1"># fill description dictionary for easy step instantiation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nonlinearschroedinger_imex</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fft_to_fft</span>

    <span class="c1"># set time parameters</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">f</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/step_7_B_out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Running with ml=</span><span class="si">{</span><span class="n">ml</span><span class="si">}</span><span class="s1"> and num_procs=</span><span class="si">{</span><span class="n">num_procs</span><span class="si">}</span><span class="s1">...&#39;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># instantiate controller</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">controller_nonMPI</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span> <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

    <span class="c1"># call main function to get things done...</span>
    <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>
    <span class="n">uex</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">Tend</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">uex</span> <span class="o">-</span> <span class="n">uend</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># filter statistics by type (number of iterations)</span>
        <span class="n">iter_counts</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

        <span class="n">niters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_counts</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;   Min/Mean/Max number of iterations: &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span><span class="si">:</span><span class="s1">4.2f</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span><span class="si">:</span><span class="s1">4.2f</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span><span class="si">:</span><span class="s1">4.2f</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Range of values for number of iterations: </span><span class="si">%2i</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Position of max/min number of iterations: </span><span class="si">%2i</span><span class="s1"> -- </span><span class="si">%2i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Std and var for number of iterations: </span><span class="si">%4.2f</span><span class="s1"> -- </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">err</span><span class="si">:</span><span class="s1">6.4e</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">timing</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;timing_run&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Time to solution: </span><span class="si">{</span><span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">6.4f</span><span class="si">}</span><span class="s1"> sec.&#39;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="mf">1.133e-05</span><span class="p">,</span> <span class="s1">&#39;Error is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
        <span class="k">if</span> <span class="n">ml</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_procs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">maxmean</span> <span class="o">=</span> <span class="mf">12.5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxmean</span> <span class="o">=</span> <span class="mf">6.6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxmean</span> <span class="o">=</span> <span class="mf">12.7</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">maxmean</span><span class="p">,</span> <span class="s1">&#39;Mean number of iterations is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Little helper routine to run the whole thing</span>

<span class="sd">    Note: This can also be run with &quot;mpirun -np 2 python B_pySDC_with_mpi4pyfft.py&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">run_simulation</span><span class="p">(</span><span class="n">spectral</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_simulation</span><span class="p">(</span><span class="n">spectral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_simulation</span><span class="p">(</span><span class="n">spectral</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_simulation</span><span class="p">(</span><span class="n">spectral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">run_simulation</span><span class="p">(</span><span class="n">spectral</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">run_simulation</span><span class="p">(</span><span class="n">spectral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mf">1.</span><span class="o">..</span>
   <span class="n">Min</span><span class="o">/</span><span class="n">Mean</span><span class="o">/</span><span class="n">Max</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">9.00</span> <span class="o">/</span> <span class="mf">12.70</span> <span class="o">/</span> <span class="mf">16.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">7</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span> <span class="mi">19</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">2.10</span> <span class="o">--</span> <span class="mf">4.41</span>
<span class="n">Error</span><span class="p">:</span> <span class="mf">1.1321e-05</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.5077</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Running</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mf">1.</span><span class="o">..</span>
   <span class="n">Min</span><span class="o">/</span><span class="n">Mean</span><span class="o">/</span><span class="n">Max</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">8.00</span> <span class="o">/</span> <span class="mf">11.40</span> <span class="o">/</span> <span class="mf">15.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">7</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span> <span class="mi">19</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">2.03</span> <span class="o">--</span> <span class="mf">4.14</span>
<span class="n">Error</span><span class="p">:</span> <span class="mf">4.1749e-06</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.2269</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Running</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mf">1.</span><span class="o">..</span>
   <span class="n">Min</span><span class="o">/</span><span class="n">Mean</span><span class="o">/</span><span class="n">Max</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">5.00</span> <span class="o">/</span> <span class="mf">6.60</span> <span class="o">/</span> <span class="mf">8.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">3</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span> <span class="mi">16</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">1.07</span> <span class="o">--</span> <span class="mf">1.14</span>
<span class="n">Error</span><span class="p">:</span> <span class="mf">1.1316e-05</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.5004</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Running</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mf">1.</span><span class="o">..</span>
   <span class="n">Min</span><span class="o">/</span><span class="n">Mean</span><span class="o">/</span><span class="n">Max</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">4.00</span> <span class="o">/</span> <span class="mf">5.95</span> <span class="o">/</span> <span class="mf">8.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">4</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span> <span class="mi">19</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">1.02</span> <span class="o">--</span> <span class="mf">1.05</span>
<span class="n">Error</span><span class="p">:</span> <span class="mf">4.1744e-06</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.3538</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Running</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mf">10.</span><span class="o">..</span>
   <span class="n">Min</span><span class="o">/</span><span class="n">Mean</span><span class="o">/</span><span class="n">Max</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">7.00</span> <span class="o">/</span> <span class="mf">12.45</span> <span class="o">/</span> <span class="mf">18.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mi">11</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">9</span> <span class="o">--</span> <span class="mi">10</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">3.11</span> <span class="o">--</span> <span class="mf">9.65</span>
<span class="n">Error</span><span class="p">:</span> <span class="mf">1.1306e-05</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">3.0460</span> <span class="n">sec</span><span class="o">.</span>

<span class="n">Running</span> <span class="k">with</span> <span class="n">ml</span><span class="o">=</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">num_procs</span><span class="o">=</span><span class="mf">10.</span><span class="o">..</span>
   <span class="n">Min</span><span class="o">/</span><span class="n">Mean</span><span class="o">/</span><span class="n">Max</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">6.00</span> <span class="o">/</span> <span class="mf">11.50</span> <span class="o">/</span> <span class="mf">17.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mi">11</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">9</span> <span class="o">--</span> <span class="mi">10</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">3.04</span> <span class="o">--</span> <span class="mf">9.25</span>
<span class="n">Error</span><span class="p">:</span> <span class="mf">4.1688e-06</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">2.8317</span> <span class="n">sec</span><span class="o">.</span>

</pre></div>
</div>
</section>
<section id="part-c-time-parallel-pysdc-with-space-parallel-petsc">
<h2>Part C: Time-parallel pySDC with space-parallel PETSc<a class="headerlink" href="#part-c-time-parallel-pysdc-with-space-parallel-petsc" title="Link to this heading">¶</a></h2>
<p>With rather unfavorable scaling properties, parallel-in-time methods are only really useful when spatial parallelization is maxed out.
To work with spatial parallelization, this part shows how to (1) include and work with an external library and (2) set up space- and time-parallel runs.
We use again the forced heat equation as our testbed and <a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a> for the space-parallel data structures and linear solver.
See <cite>implementations/datatype_classes/petsc_dmda_grid.py</cite> and <cite>implementations/problem_classes/HeatEquation_2D_PETSc_forced.py</cite> for details on the PETSc bindings.</p>
<p>Important things to note:</p>
<ul class="simple">
<li><p>We need processors in space and time, which can be achieved by <cite>comm.Split</cite> and coloring. The space-communicator is then passed to the problem class.</p></li>
<li><p>Below, we run the code 3 times: with 1 and 2 processors in space as well as 4 processors (2 in time and 2 in space). Do not expect scaling due to the CI environment.</p></li>
</ul>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/tutorial/step_7/C_pySDC_with_PETSc.py">pySDC/tutorial/step_7/C_pySDC_with_PETSc.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>

<span class="kn">from</span> <span class="nn">pySDC.helpers.stats_helper</span> <span class="kn">import</span> <span class="n">get_sorted</span>

<span class="kn">from</span> <span class="nn">pySDC.implementations.controller_classes.controller_MPI</span> <span class="kn">import</span> <span class="n">controller_MPI</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.HeatEquation_2D_PETSc_forced</span> <span class="kn">import</span> <span class="n">heat2d_petsc_forced</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.imex_1st_order</span> <span class="kn">import</span> <span class="n">imex_1st_order</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.transfer_classes.TransferPETScDMDA</span> <span class="kn">import</span> <span class="n">mesh_to_mesh_petsc_dmda</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Program to demonstrate usage of PETSc data structures and spatial parallelization,</span>
<span class="sd">    combined with parallelization in time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set MPI communicator</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>

    <span class="n">world_rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
    <span class="n">world_size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>

    <span class="c1"># split world communicator to create space-communicators</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">world_rank</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">world_rank</span> <span class="o">/</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">space_comm</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">space_rank</span> <span class="o">=</span> <span class="n">space_comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>

    <span class="c1"># split world communicator to create time-communicators</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">world_rank</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">world_rank</span> <span class="o">/</span> <span class="n">world_size</span><span class="p">)</span>
    <span class="n">time_comm</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">time_rank</span> <span class="o">=</span> <span class="n">time_comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>

    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-08</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.125</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;nsweeps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;quad_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RADAU-RIGHT&#39;</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LU&#39;</span><span class="p">]</span>  <span class="c1"># For the IMEX sweeper, the LU-trick can be activated for the implicit part</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;initial_guess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;zero&#39;</span>

    <span class="c1"># initialize problem parameters</span>
    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># diffusion coefficient</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># frequency for the test value</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;cnvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">65</span><span class="p">)]</span>  <span class="c1"># number of degrees of freedom for the coarsest level</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;refine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># number of refinements</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space_comm</span>  <span class="c1"># pass space-communicator to problem class</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;sol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-12</span>  <span class="c1"># set tolerance to PETSc&#39; linear solver</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1"># initialize space transfer parameters</span>
    <span class="n">space_transfer_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;rorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;iorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;periodic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span> <span class="k">if</span> <span class="n">space_rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">99</span>  <span class="c1"># set level depending on rank</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;dump_setup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># fill description dictionary for easy step instantiation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heat2d_petsc_forced</span>  <span class="c1"># pass problem class</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>  <span class="c1"># pass sweeper (see part B)</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_to_mesh_petsc_dmda</span>  <span class="c1"># pass spatial transfer class</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space_transfer_params</span>  <span class="c1"># pass parameters for spatial transfer</span>

    <span class="c1"># set time parameters</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="c1"># instantiate controller</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">controller_MPI</span><span class="p">(</span><span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">time_comm</span><span class="p">)</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

    <span class="c1"># call main function to get things done...</span>
    <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

    <span class="c1"># compute exact solution and compare</span>
    <span class="n">uex</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">Tend</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">uex</span> <span class="o">-</span> <span class="n">uend</span><span class="p">)</span>

    <span class="c1"># filter statistics by type (number of iterations)</span>
    <span class="n">iter_counts</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="n">niters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_counts</span><span class="p">])</span>

    <span class="c1"># limit output to space-rank 0 (as before when setting the logger level)</span>
    <span class="k">if</span> <span class="n">space_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;step_7_C_out.txt&#39;</span>
        <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/&#39;</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;This is time-rank </span><span class="si">%i</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="n">time_rank</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="c1"># compute and print statistics</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_counts</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Number of iterations for time </span><span class="si">%4.2f</span><span class="s1">: </span><span class="si">%2i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Mean number of iterations: </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Range of values for number of iterations: </span><span class="si">%2i</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Position of max/min number of iterations: </span><span class="si">%2i</span><span class="s1"> -- </span><span class="si">%2i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Std and var for number of iterations: </span><span class="si">%4.2f</span><span class="s1"> -- </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">timing</span> <span class="o">=</span> <span class="n">get_sorted</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;timing_run&#39;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Time to solution: </span><span class="si">%6.4f</span><span class="s1"> sec.&#39;</span> <span class="o">%</span> <span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Error vs. PDE solution: </span><span class="si">%6.4e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mf">2e-04</span><span class="p">,</span> <span class="s1">&#39;ERROR: did not match error tolerance, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;ERROR: number of iterations is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>

    <span class="n">space_comm</span><span class="o">.</span><span class="n">Free</span><span class="p">()</span>
    <span class="n">time_comm</span><span class="o">.</span><span class="n">Free</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Results:</p>
<p>1 processor in time, 1 processor in space</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="ow">is</span> <span class="n">time</span><span class="o">-</span><span class="n">rank</span> <span class="mf">0.</span><span class="o">..</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="k">for</span> <span class="n">time</span> <span class="mf">0.00</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="k">for</span> <span class="n">time</span> <span class="mf">0.12</span><span class="p">:</span> <span class="mi">12</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">12.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">0.00</span> <span class="o">--</span> <span class="mf">0.00</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.7831</span> <span class="n">sec</span><span class="o">.</span>
<span class="n">Error</span> <span class="n">vs</span><span class="o">.</span> <span class="n">PDE</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.9479e-04</span>
</pre></div>
</div>
<p>1 processor in time, 2 processors in space</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="ow">is</span> <span class="n">time</span><span class="o">-</span><span class="n">rank</span> <span class="mf">0.</span><span class="o">..</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="k">for</span> <span class="n">time</span> <span class="mf">0.00</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="k">for</span> <span class="n">time</span> <span class="mf">0.12</span><span class="p">:</span> <span class="mi">12</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">12.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">0.00</span> <span class="o">--</span> <span class="mf">0.00</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">0.8934</span> <span class="n">sec</span><span class="o">.</span>
<span class="n">Error</span> <span class="n">vs</span><span class="o">.</span> <span class="n">PDE</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.9479e-04</span>
</pre></div>
</div>
<p>2 processor in time, 2 processors in space</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="ow">is</span> <span class="n">time</span><span class="o">-</span><span class="n">rank</span> <span class="mf">1.</span><span class="o">..</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="k">for</span> <span class="n">time</span> <span class="mf">0.12</span><span class="p">:</span> <span class="mi">12</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">12.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">0.00</span> <span class="o">--</span> <span class="mf">0.00</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.0846</span> <span class="n">sec</span><span class="o">.</span>
<span class="n">Error</span> <span class="n">vs</span><span class="o">.</span> <span class="n">PDE</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.9479e-04</span>
<span class="n">This</span> <span class="ow">is</span> <span class="n">time</span><span class="o">-</span><span class="n">rank</span> <span class="mf">0.</span><span class="o">..</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">iterations</span> <span class="k">for</span> <span class="n">time</span> <span class="mf">0.00</span><span class="p">:</span> <span class="mi">12</span>
   <span class="n">Mean</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">12.00</span>
   <span class="n">Range</span> <span class="n">of</span> <span class="n">values</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> 
   <span class="n">Position</span> <span class="n">of</span> <span class="nb">max</span><span class="o">/</span><span class="nb">min</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">0</span> <span class="o">--</span>  <span class="mi">0</span>
   <span class="n">Std</span> <span class="ow">and</span> <span class="n">var</span> <span class="k">for</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="p">:</span> <span class="mf">0.00</span> <span class="o">--</span> <span class="mf">0.00</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.0852</span> <span class="n">sec</span><span class="o">.</span>
<span class="n">Error</span> <span class="n">vs</span><span class="o">.</span> <span class="n">PDE</span> <span class="n">solution</span><span class="p">:</span> <span class="mf">1.9479e-04</span>
</pre></div>
</div>
</section>
<section id="part-d-pysdc-and-pytorch">
<h2>Part D: pySDC and PyTorch<a class="headerlink" href="#part-d-pysdc-and-pytorch" title="Link to this heading">¶</a></h2>
<p>PyTorch is a library for machine learning. The data structure is called tensor and allows to run on CPUs as well as GPUs in addition to access to various machine learning methods.
Since the potential for use in pySDC is very large, we have started on a datatype that allows to use PyTorch tensors throughout pySDC.</p>
<p>This example trains a network to predict the results of implicit Euler solves for the heat equation. It is too simple to do anything useful, but demonstrates how to use tensors in pySDC and then apply the enormous PyTorch infrastructure.
This is work in progress in very early stages! The tensor datatype is the simplest possible implementation, rather than an efficient one.
If you want to work on this, your input is appreciated!</p>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/tutorial/step_7/D_pySDC_with_PyTorch.py">pySDC/tutorial/step_7/D_pySDC_with_PyTorch.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">pySDC.playgrounds.ML_initial_guess.ml_heat</span> <span class="kn">import</span> <span class="n">HeatEquationModel</span><span class="p">,</span> <span class="n">Train_pySDC</span>
<span class="kn">from</span> <span class="nn">pySDC.playgrounds.ML_initial_guess.heat</span> <span class="kn">import</span> <span class="n">Heat1DFDTensor</span>


<span class="k">def</span> <span class="nf">train_at_collocation_nodes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For the first proof of concept, we want to train the model specifically to the collocation nodes we use in SDC.</span>
<span class="sd">    If successful, the initial guess would already be the exact solution and we would need no SDC iterations.</span>

<span class="sd">    What we find is that we can train the network to predict the solution to one very specific problem rather well.</span>
<span class="sd">    See the error during training for what happens when we ask the network to solve for exactly what it just trained.</span>
<span class="sd">    However, if we train for something else, i.e. solving to a different step size in this case, we can only use the</span>
<span class="sd">    model to predict the solution of what it&#39;s been trained for last and it loses the ability to solve for previously</span>
<span class="sd">    learned things. This is solely because we chose an overly simple model that is unsuitable to the task at hand and</span>
<span class="sd">    is likely easily solved with a bit of patience. This is just a demonstration of the interface between pySDC and</span>
<span class="sd">    PyTorch. If you want to do a project with this, feel free to take this as a starting point and do things that</span>
<span class="sd">    actually do something!</span>

<span class="sd">    The output shows the training loss during training and, after each of three training sessions is complete, the error</span>
<span class="sd">    of the prediction with the current state of the network. To demonstrate the forgetfulness, we finally print the</span>
<span class="sd">    error of all learned predictions after training is complete.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">errors_mid_training</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors_post_training</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># instantiate the pySDC problem and a model for PyTorch</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">Heat1DFDTensor</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">HeatEquationModel</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

    <span class="c1"># setup neural network</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">250</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>

    <span class="c1"># setup initial conditions</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">initial_condition</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># train the model to predict the solution at certain collocation nodes</span>
    <span class="n">collocation_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.15505102572168285</span><span class="p">,</span> <span class="mf">0.6449489742783183</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-2</span>
    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">collocation_nodes</span><span class="p">:</span>

        <span class="c1"># get target condition from implicit Euler step</span>
        <span class="n">target_condition</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve_system</span><span class="p">(</span><span class="n">initial_condition</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">initial_condition</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="c1"># do the training</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
            <span class="n">predicted_state</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">initial_condition</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predicted_state</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">target_condition</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Training for </span><span class="si">{</span><span class="n">dt</span><span class="si">=:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">: Epoch [</span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s1">4d</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">:</span><span class="s1">4d</span><span class="si">}</span><span class="s1">], Loss: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4e</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="c1"># evaluate model to compute error</span>
        <span class="n">model_prediction</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">initial_condition</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">errors_mid_training</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">target_condition</span> <span class="o">-</span> <span class="n">model_prediction</span><span class="p">)]</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Error of prediction at </span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> during training: </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">target_condition</span><span class="o">-</span><span class="n">model_prediction</span><span class="p">)</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="c1"># compare model and problem</span>
    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">collocation_nodes</span><span class="p">:</span>
        <span class="n">target_condition</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve_system</span><span class="p">(</span><span class="n">initial_condition</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">initial_condition</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">model_prediction</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">initial_condition</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">errors_post_training</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">target_condition</span> <span class="o">-</span> <span class="n">model_prediction</span><span class="p">)]</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Error of prediction at </span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> after training: </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">target_condition</span><span class="o">-</span><span class="n">model_prediction</span><span class="p">)</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/step_7_D_out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># test that the training went as expected</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">([</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">],</span> <span class="n">errors_mid_training</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s1">&#39;Errors during training are larger than expected&#39;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">([</span><span class="mf">1e0</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">],</span> <span class="n">errors_post_training</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s1">&#39;Errors after training are larger than expected&#39;</span>

    <span class="c1"># save the model to use it throughout pySDC</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;data/heat_equation_model.pth&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">train_at_collocation_nodes</span><span class="p">()</span>
</pre></div>
</div>
<p>Results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.55e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span>  <span class="mi">50</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">7.7374e-03</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.55e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">100</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">2.1262e-05</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.55e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">150</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">1.4054e-07</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.55e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">200</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">8.3420e-10</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.55e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">250</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">5.8492e-12</span>
<span class="n">Error</span> <span class="n">of</span> <span class="n">prediction</span> <span class="n">at</span> <span class="mf">1.55e-03</span> <span class="n">during</span> <span class="n">training</span><span class="p">:</span> <span class="mf">1.48e-05</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">6.45e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span>  <span class="mi">50</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">1.6945e-04</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">6.45e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">100</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">7.1186e-07</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">6.45e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">150</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">4.4676e-09</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">6.45e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">200</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">9.3994e-12</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">6.45e-03</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">250</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">5.0393e-14</span>
<span class="n">Error</span> <span class="n">of</span> <span class="n">prediction</span> <span class="n">at</span> <span class="mf">6.45e-03</span> <span class="n">during</span> <span class="n">training</span><span class="p">:</span> <span class="mf">9.51e-07</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.00e-02</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span>  <span class="mi">50</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">3.5797e-06</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.00e-02</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">100</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">9.3890e-08</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.00e-02</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">150</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">4.8417e-10</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.00e-02</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">200</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">1.4955e-12</span>
<span class="n">Training</span> <span class="k">for</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.00e-02</span><span class="p">:</span> <span class="n">Epoch</span> <span class="p">[</span> <span class="mi">250</span><span class="o">/</span> <span class="mi">250</span><span class="p">],</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">1.6345e-14</span>
<span class="n">Error</span> <span class="n">of</span> <span class="n">prediction</span> <span class="n">at</span> <span class="mf">1.00e-02</span> <span class="n">during</span> <span class="n">training</span><span class="p">:</span> <span class="mf">3.81e-07</span>
<span class="n">Error</span> <span class="n">of</span> <span class="n">prediction</span> <span class="n">at</span> <span class="mf">1.55e-03</span> <span class="n">after</span> <span class="n">training</span><span class="p">:</span> <span class="mf">4.26e-01</span>
<span class="n">Error</span> <span class="n">of</span> <span class="n">prediction</span> <span class="n">at</span> <span class="mf">6.45e-03</span> <span class="n">after</span> <span class="n">training</span><span class="p">:</span> <span class="mf">1.12e-01</span>
<span class="n">Error</span> <span class="n">of</span> <span class="n">prediction</span> <span class="n">at</span> <span class="mf">1.00e-02</span> <span class="n">after</span> <span class="n">training</span><span class="p">:</span> <span class="mf">3.81e-07</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Step-7: pySDC with external libraries</a><ul>
<li><a class="reference internal" href="#part-a-pysdc-and-fenics">Part A: pySDC and FEniCS</a></li>
<li><a class="reference internal" href="#part-b-mpi4py-fft-for-parallel-fourier-transforms">Part B: mpi4py-fft for parallel Fourier transforms</a></li>
<li><a class="reference internal" href="#part-c-time-parallel-pysdc-with-space-parallel-petsc">Part C: Time-parallel pySDC with space-parallel PETSc</a></li>
<li><a class="reference internal" href="#part-d-pysdc-and-pytorch">Part D: pySDC and PyTorch</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="step_6.html"
                          title="previous chapter">Step-6: Advanced PFASST controllers</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="step_8.html"
                          title="next chapter">Step-8: Advanced topics</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorial/step_7.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="step_8.html" title="Step-8: Advanced topics"
             >next</a> |</li>
        <li class="right" >
          <a href="step_6.html" title="Step-6: Advanced PFASST controllers"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 5.5.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Step-7: pySDC with external libraries</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Robert Speck.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
    </div>
  </body>
</html>