<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; pySDC 5.5.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css?v=2bf1fcf8" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=c40552b6" />
    
    <script src="../_static/documentation_options.js?v=3005adad"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 5.5.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">&lt;no title&gt;</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/tutorial/step_7/F_pySDC_with_Gusto.py">pySDC/tutorial/step_7/F_pySDC_with_Gusto.py</a>
Find a suitable plotting script here: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/tutorial/step_7/F_2_plot_pySDC_with_Gusto_result.py">pySDC/tutorial/step_7/F_2_plot_pySDC_with_Gusto_result.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example for running pySDC together with Gusto. This test runs a shallow water equation and may take a considerable</span>
<span class="sd">amount of time. After you have run it, move on to step F_2, which includes a plotting script.</span>

<span class="sd">This is Test Case 5 (flow over a mountain) of Williamson et al, 1992:</span>
<span class="sd">``A standard test set for numerical approximations to the shallow water</span>
<span class="sd">equations in spherical geometry&#39;&#39;, JCP.</span>

<span class="sd">This script is adapted from the Gusto example: https://github.com/firedrakeproject/gusto/blob/main/examples/shallow_water/williamson_5.py</span>

<span class="sd">The pySDC coupling works by setting up pySDC as a time integrator within Gusto.</span>
<span class="sd">To this end, you need to construct a pySDC description and controller parameters as usual and pass them when</span>
<span class="sd">constructing the pySDC time discretization.</span>

<span class="sd">After passing this to a Gusto timestepper, you have two choices:</span>
<span class="sd">    - Access the `.scheme.controller` variable of the timestepper, which is the pySDC controller and use pySDC for</span>
<span class="sd">      running</span>
<span class="sd">    - Use the Gusto timestepper for running</span>
<span class="sd">You may wonder why it is necessary to construct a Gusto timestepper if you don&#39;t want to use it. The reason is the</span>
<span class="sd">setup of spatial methods, such as upwinding. These are passed to the Gusto timestepper and modify the residual of the</span>
<span class="sd">equations during its instantiation. Once the residual is modified, we can choose whether to continue in Gusto or pySDC.</span>

<span class="sd">This script supports space-time parallelism, as well as running the Gusto SDC implementation or the pySDC-Gusto coupling.</span>
<span class="sd">Please run with `--help` to learn how to configure this script.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">firedrake</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.helpers.pySDC_as_gusto_time_discretization</span><span class="w"> </span><span class="kn">import</span> <span class="n">pySDC_integrator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.helpers.firedrake_ensemble_communicator</span><span class="w"> </span><span class="kn">import</span> <span class="n">FiredrakeEnsembleCommunicator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gusto</span><span class="w"> </span><span class="kn">import</span> <span class="n">SDC</span><span class="p">,</span> <span class="n">BackwardEuler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gusto.core.labels</span><span class="w"> </span><span class="kn">import</span> <span class="n">implicit</span><span class="p">,</span> <span class="n">time_derivative</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gusto.core.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">INFO</span>

<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">argparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArgumentParser</span><span class="p">,</span> <span class="n">ArgumentDefaultsHelpFormatter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">firedrake</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpatialCoordinate</span><span class="p">,</span> <span class="n">as_vector</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">Function</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gusto</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Domain</span><span class="p">,</span>
    <span class="n">IO</span><span class="p">,</span>
    <span class="n">OutputParameters</span><span class="p">,</span>
    <span class="n">DGUpwind</span><span class="p">,</span>
    <span class="n">ShallowWaterParameters</span><span class="p">,</span>
    <span class="n">ShallowWaterEquations</span><span class="p">,</span>
    <span class="n">Sum</span><span class="p">,</span>
    <span class="n">lonlatr_from_xyz</span><span class="p">,</span>
    <span class="n">GeneralIcosahedralSphereMesh</span><span class="p">,</span>
    <span class="n">ZonalComponent</span><span class="p">,</span>
    <span class="n">MeridionalComponent</span><span class="p">,</span>
    <span class="n">RelativeVorticity</span><span class="p">,</span>
    <span class="n">Timestepper</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">williamson_5_defaults</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ncells_per_edge&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>  <span class="c1"># number of cells per icosahedron edge</span>
    <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="mf">900.0</span><span class="p">,</span>
    <span class="s1">&#39;tmax&#39;</span><span class="p">:</span> <span class="mf">50.0</span> <span class="o">*</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">,</span>  <span class="c1"># 50 days</span>
    <span class="s1">&#39;dumpfreq&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># output every &lt;dumpfreq&gt; steps</span>
    <span class="s1">&#39;dirname&#39;</span><span class="p">:</span> <span class="s1">&#39;williamson_5&#39;</span><span class="p">,</span>  <span class="c1"># results will go into ./results/&lt;dirname&gt;</span>
    <span class="s1">&#39;time_parallelism&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># use parallel diagonal SDC or not</span>
    <span class="s1">&#39;QI&#39;</span><span class="p">:</span> <span class="s1">&#39;MIN-SR-S&#39;</span><span class="p">,</span>  <span class="c1"># implicit preconditioner</span>
    <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>  <span class="c1"># number of collocation nodes</span>
    <span class="s1">&#39;kmax&#39;</span><span class="p">:</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span>  <span class="c1"># use fixed number of iteration up to this value</span>
    <span class="s1">&#39;use_pySDC&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># whether to use pySDC for time integration</span>
    <span class="s1">&#39;use_adaptivity&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># whether to use adaptive step size selection</span>
    <span class="s1">&#39;Nlevels&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># number of levels in SDC</span>
    <span class="s1">&#39;logger_level&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>  <span class="c1"># pySDC logger level</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">williamson_5</span><span class="p">(</span>
    <span class="n">ncells_per_edge</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;ncells_per_edge&#39;</span><span class="p">],</span>
    <span class="n">dt</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span>
    <span class="n">tmax</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">],</span>
    <span class="n">dumpfreq</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;dumpfreq&#39;</span><span class="p">],</span>
    <span class="n">dirname</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;dirname&#39;</span><span class="p">],</span>
    <span class="n">time_parallelism</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;time_parallelism&#39;</span><span class="p">],</span>
    <span class="n">QI</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">],</span>
    <span class="n">M</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">],</span>
    <span class="n">kmax</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;kmax&#39;</span><span class="p">],</span>
    <span class="n">use_pySDC</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;use_pySDC&#39;</span><span class="p">],</span>
    <span class="n">use_adaptivity</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;use_adaptivity&#39;</span><span class="p">],</span>
    <span class="n">Nlevels</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;Nlevels&#39;</span><span class="p">],</span>
    <span class="n">logger_level</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">],</span>
    <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">_ML_is_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the Williamson 5 test case.</span>

<span class="sd">    Args:</span>
<span class="sd">        ncells_per_edge (int): number of cells per icosahedron edge</span>
<span class="sd">        dt (float): Initial step size</span>
<span class="sd">        tmax (float): Time to integrate to</span>
<span class="sd">        dumpfreq (int): Output every &lt;dumpfreq&gt; time steps</span>
<span class="sd">        dirname (str): Output will go into ./results/&lt;dirname&gt;</span>
<span class="sd">        time_parallelism (bool): True for parallel SDC, False for serial</span>
<span class="sd">        M (int): Number of collocation nodes</span>
<span class="sd">        kmax (int): Max number of SDC iterations</span>
<span class="sd">        use_pySDC (bool): Use pySDC as Gusto time integrator or Gusto SDC implementation</span>
<span class="sd">        Nlevels (int): Number of SDC levels</span>
<span class="sd">        logger_level (int): Logger level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_pySDC</span> <span class="ow">and</span> <span class="n">use_adaptivity</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Adaptive step size selection not yet implemented in Gusto&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_pySDC</span> <span class="ow">and</span> <span class="n">Nlevels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Multi-level SDC not yet implemented in Gusto&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">time_parallelism</span> <span class="ow">and</span> <span class="n">Nlevels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Multi-level SDC does not work with MPI parallel sweeper yet&#39;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># Parameters for test case</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="mf">6371220.0</span>  <span class="c1"># planetary radius (m)</span>
    <span class="n">mean_depth</span> <span class="o">=</span> <span class="mi">5960</span>  <span class="c1"># reference depth (m)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mf">9.80616</span>  <span class="c1"># acceleration due to gravity (m/s^2)</span>
    <span class="n">u_max</span> <span class="o">=</span> <span class="mf">20.0</span>  <span class="c1"># max amplitude of the zonal wind (m/s)</span>
    <span class="n">mountain_height</span> <span class="o">=</span> <span class="mf">2000.0</span>  <span class="c1"># height of mountain (m)</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">/</span> <span class="mf">9.0</span>  <span class="c1"># radius of mountain (rad)</span>
    <span class="n">lamda_c</span> <span class="o">=</span> <span class="o">-</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># longitudinal centre of mountain (rad)</span>
    <span class="n">phi_c</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">/</span> <span class="mf">6.0</span>  <span class="c1"># latitudinal centre of mountain (rad)</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># Our settings for this set up</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="n">element_order</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># Set up model objects</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="c1"># parallelism</span>
    <span class="k">if</span> <span class="n">time_parallelism</span><span class="p">:</span>
        <span class="n">ensemble_comm</span> <span class="o">=</span> <span class="n">FiredrakeEnsembleCommunicator</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">fd</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="n">M</span><span class="p">)</span>
        <span class="n">space_comm</span> <span class="o">=</span> <span class="n">ensemble_comm</span><span class="o">.</span><span class="n">space_comm</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.sweeper_classes.generic_implicit_MPI</span><span class="w"> </span><span class="kn">import</span> <span class="n">generic_implicit_MPI</span> <span class="k">as</span> <span class="n">sweeper_class</span>

        <span class="k">if</span> <span class="n">ensemble_comm</span><span class="o">.</span><span class="n">time_comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ensemble_comm</span><span class="o">.</span><span class="n">time_comm</span><span class="o">.</span><span class="n">rank</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ensemble_comm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">space_comm</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">COMM_WORLD</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.sweeper_classes.generic_implicit</span><span class="w"> </span><span class="kn">import</span> <span class="n">generic_implicit</span> <span class="k">as</span> <span class="n">sweeper_class</span>

    <span class="c1"># Domain</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">GeneralIcosahedralSphereMesh</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">ncells_per_edge</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">space_comm</span><span class="p">)</span> <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mesh</span>
    <span class="k">if</span> <span class="n">Nlevels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">MeshHierarchy</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">Nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">Domain</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;BDM&#39;</span><span class="p">,</span> <span class="n">element_order</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">lamda</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lonlatr_from_xyz</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="c1"># Equation: coriolis</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">ShallowWaterParameters</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">mean_depth</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">Omega</span>
    <span class="n">fexpr</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Omega</span> <span class="o">*</span> <span class="n">z</span> <span class="o">/</span> <span class="n">radius</span>

    <span class="c1"># Equation: topography</span>
    <span class="n">rsq</span> <span class="o">=</span> <span class="n">min_value</span><span class="p">(</span><span class="n">R0</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">lamda</span> <span class="o">-</span> <span class="n">lamda_c</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">phi_c</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">rsq</span><span class="p">)</span>
    <span class="n">tpexpr</span> <span class="o">=</span> <span class="n">mountain_height</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span> <span class="o">/</span> <span class="n">R0</span><span class="p">)</span>
    <span class="n">eqns</span> <span class="o">=</span> <span class="n">ShallowWaterEquations</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">fexpr</span><span class="o">=</span><span class="n">fexpr</span><span class="p">,</span> <span class="n">topog_expr</span><span class="o">=</span><span class="n">tpexpr</span><span class="p">)</span>

    <span class="n">eqns</span><span class="o">.</span><span class="n">label_terms</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">has_label</span><span class="p">(</span><span class="n">time_derivative</span><span class="p">),</span> <span class="n">implicit</span><span class="p">)</span>

    <span class="c1"># I/O</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">OutputParameters</span><span class="p">(</span>
        <span class="n">dirname</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span>
        <span class="n">dumplist_latlon</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">],</span>
        <span class="n">dumpfreq</span><span class="o">=</span><span class="n">dumpfreq</span><span class="p">,</span>
        <span class="n">dump_vtus</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dump_nc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dumplist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;topography&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">diagnostic_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;topography&#39;</span><span class="p">),</span> <span class="n">RelativeVorticity</span><span class="p">(),</span> <span class="n">MeridionalComponent</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">),</span> <span class="n">ZonalComponent</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)]</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">IO</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">diagnostic_fields</span><span class="o">=</span><span class="n">diagnostic_fields</span><span class="p">)</span>

    <span class="c1"># Transport schemes</span>
    <span class="n">transport_methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">DGUpwind</span><span class="p">(</span><span class="n">eqns</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">),</span> <span class="n">DGUpwind</span><span class="p">(</span><span class="n">eqns</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)]</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># pySDC parameters: description and controller parameters</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;residual_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;full_rel&#39;</span>

    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmax</span>

    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;quad_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RADAU-RIGHT&#39;</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;node_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LEGENDRE&#39;</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">QI</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PIC&#39;</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble_comm</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;initial_guess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;copy&#39;</span>

    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">convergence_controllers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">use_adaptivity</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.convergence_controller_classes.adaptivity</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adaptivity</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.convergence_controller_classes.spread_step_sizes</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">SpreadStepSizesBlockwiseNonMPI</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">convergence_controllers</span><span class="p">[</span><span class="n">Adaptivity</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;e_tol&#39;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="s1">&#39;rel_error&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;dt_max&#39;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span> <span class="s1">&#39;dt_rel_min_slope&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
        <span class="c1"># this is needed because the coupling runs on the controller level and this will almost always overwrite</span>
        <span class="n">convergence_controllers</span><span class="p">[</span><span class="n">SpreadStepSizesBlockwiseNonMPI</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;overwrite_to_reach_Tend&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logger_level</span> <span class="k">if</span> <span class="n">fd</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">30</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;mssdc_jac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_class</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;convergence_controllers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convergence_controllers</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">pySDC.implementations.transfer_classes.TransferFiredrakeMesh</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeshToMeshFiredrakeHierarchy</span>

    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MeshToMeshFiredrakeHierarchy</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># petsc solver parameters</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="n">solver_parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;snes_type&#39;</span><span class="p">:</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ksp_type&#39;</span><span class="p">:</span> <span class="s1">&#39;gmres&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pc_type&#39;</span><span class="p">:</span> <span class="s1">&#39;bjacobi&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sub_pc_type&#39;</span><span class="p">:</span> <span class="s1">&#39;ilu&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ksp_rtol&#39;</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span>
        <span class="s1">&#39;snes_rtol&#39;</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span>
        <span class="s1">&#39;ksp_atol&#39;</span><span class="p">:</span> <span class="mf">1e-30</span><span class="p">,</span>
        <span class="s1">&#39;snes_atol&#39;</span><span class="p">:</span> <span class="mf">1e-30</span><span class="p">,</span>
        <span class="s1">&#39;ksp_divtol&#39;</span><span class="p">:</span> <span class="mf">1e30</span><span class="p">,</span>
        <span class="s1">&#39;snes_divtol&#39;</span><span class="p">:</span> <span class="mf">1e30</span><span class="p">,</span>
        <span class="s1">&#39;snes_max_it&#39;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
        <span class="s1">&#39;ksp_max_it&#39;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># Set Gusto SDC parameters to match the pySDC ones</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="n">SDC_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;base_scheme&#39;</span><span class="p">:</span> <span class="n">BackwardEuler</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="n">solver_parameters</span><span class="p">),</span>
        <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">],</span>
        <span class="s1">&#39;maxk&#39;</span><span class="p">:</span> <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">],</span>
        <span class="s1">&#39;quad_type&#39;</span><span class="p">:</span> <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;quad_type&#39;</span><span class="p">],</span>
        <span class="s1">&#39;node_type&#39;</span><span class="p">:</span> <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;node_type&#39;</span><span class="p">],</span>
        <span class="s1">&#39;qdelta_imp&#39;</span><span class="p">:</span> <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">],</span>
        <span class="s1">&#39;qdelta_exp&#39;</span><span class="p">:</span> <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QE&#39;</span><span class="p">],</span>
        <span class="s1">&#39;formulation&#39;</span><span class="p">:</span> <span class="s1">&#39;Z2N&#39;</span><span class="p">,</span>
        <span class="s1">&#39;initial_guess&#39;</span><span class="p">:</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nonlinear_solver_parameters&#39;</span><span class="p">:</span> <span class="n">solver_parameters</span><span class="p">,</span>
        <span class="s1">&#39;linear_solver_parameters&#39;</span><span class="p">:</span> <span class="n">solver_parameters</span><span class="p">,</span>
        <span class="s1">&#39;final_update&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># Setup time stepper</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="k">if</span> <span class="n">use_pySDC</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">pySDC_integrator</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">controller_params</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="n">solver_parameters</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">SDC</span><span class="p">(</span><span class="o">**</span><span class="n">SDC_params</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>

    <span class="n">stepper</span> <span class="o">=</span> <span class="n">Timestepper</span><span class="p">(</span><span class="n">eqns</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">spatial_methods</span><span class="o">=</span><span class="n">transport_methods</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># Setup multi-level SDC</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_ML_is_setup</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stepper</span>

    <span class="k">if</span> <span class="n">Nlevels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">steppers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">Nlevels</span><span class="p">)</span>
        <span class="n">steppers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stepper</span>

        <span class="c1"># get different steppers on the different levels</span>
        <span class="c1"># recall that the setup of the problems is only finished when the stepper is setup</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nlevels</span><span class="p">):</span>
            <span class="n">steppers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">williamson_5</span><span class="p">(</span>
                <span class="n">ncells_per_edge</span><span class="o">=</span><span class="n">ncells_per_edge</span><span class="p">,</span>
                <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span>
                <span class="n">dumpfreq</span><span class="o">=</span><span class="n">dumpfreq</span><span class="p">,</span>
                <span class="n">dirname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s1">_unused_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">time_parallelism</span><span class="o">=</span><span class="n">time_parallelism</span><span class="p">,</span>
                <span class="n">QI</span><span class="o">=</span><span class="n">QI</span><span class="p">,</span>
                <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
                <span class="n">kmax</span><span class="o">=</span><span class="n">kmax</span><span class="p">,</span>
                <span class="n">use_pySDC</span><span class="o">=</span><span class="n">use_pySDC</span><span class="p">,</span>
                <span class="n">use_adaptivity</span><span class="o">=</span><span class="n">use_adaptivity</span><span class="p">,</span>
                <span class="n">Nlevels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">mesh</span><span class="o">=</span><span class="n">hierarchy</span><span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># mind that the finest level in pySDC is 0, but -1 in hierarchy</span>
                <span class="n">logger_level</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                <span class="n">_ML_is_setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># update description and setup pySDC again with the discretizations from different steppers</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">][</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">me</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">residual</span> <span class="k">for</span> <span class="n">me</span> <span class="ow">in</span> <span class="n">steppers</span><span class="p">]</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">][</span><span class="s1">&#39;equation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">me</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">equation</span> <span class="k">for</span> <span class="n">me</span> <span class="ow">in</span> <span class="n">steppers</span><span class="p">]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">pySDC_integrator</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">controller_params</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="n">stepper</span> <span class="o">=</span> <span class="n">Timestepper</span><span class="p">(</span><span class="n">eqns</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">spatial_methods</span><span class="o">=</span><span class="n">transport_methods</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># Initial conditions</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="n">u0</span> <span class="o">=</span> <span class="n">stepper</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
    <span class="n">D0</span> <span class="o">=</span> <span class="n">stepper</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="n">uexpr</span> <span class="o">=</span> <span class="n">as_vector</span><span class="p">([</span><span class="o">-</span><span class="n">u_max</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="n">radius</span><span class="p">,</span> <span class="n">u_max</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">radius</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">Dexpr</span> <span class="o">=</span> <span class="n">mean_depth</span> <span class="o">-</span> <span class="n">tpexpr</span> <span class="o">-</span> <span class="p">(</span><span class="n">radius</span> <span class="o">*</span> <span class="n">Omega</span> <span class="o">*</span> <span class="n">u_max</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">u_max</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="n">radius</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">g</span>

    <span class="n">u0</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">uexpr</span><span class="p">)</span>
    <span class="n">D0</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">Dexpr</span><span class="p">)</span>

    <span class="n">Dbar</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">D0</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">mean_depth</span><span class="p">)</span>
    <span class="n">stepper</span><span class="o">.</span><span class="n">set_reference_profiles</span><span class="p">([(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">Dbar</span><span class="p">)])</span>

    <span class="c1"># ------------------------------------------------------------------------ #</span>
    <span class="c1"># Run</span>
    <span class="c1"># ------------------------------------------------------------------------ #</span>

    <span class="k">if</span> <span class="n">use_pySDC</span> <span class="ow">and</span> <span class="n">use_adaptivity</span><span class="p">:</span>
        <span class="c1"># we have to do this for adaptive time stepping, because it is a bit of a mess</span>
        <span class="n">method</span><span class="o">.</span><span class="n">timestepper</span> <span class="o">=</span> <span class="n">stepper</span>

    <span class="n">stepper</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stepper</span><span class="p">,</span> <span class="n">mesh</span>


<span class="c1"># ---------------------------------------------------------------------------- #</span>
<span class="c1"># MAIN</span>
<span class="c1"># ---------------------------------------------------------------------------- #</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--ncells_per_edge&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of cells per edge of icosahedron&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;ncells_per_edge&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dt&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The time step in seconds.&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--tmax&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The end time for the simulation in seconds.&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--dumpfreq&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The frequency at which to dump field output.&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;dumpfreq&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--dirname&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The name of the directory to write to.&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;dirname&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--time_parallelism&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use parallel diagonal SDC or not.&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;time_parallelism&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--kmax&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;SDC iteration count&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;kmax&#39;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-M&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;SDC node count&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--use_pySDC&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;whether to use pySDC or Gusto SDC implementation&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;use_pySDC&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--use_adaptivity&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;whether to use adaptive step size selection&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;use_adaptivity&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--QI&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Implicit preconditioner&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--Nlevels&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of SDC levels.&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">williamson_5_defaults</span><span class="p">[</span><span class="s1">&#39;Nlevels&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">unknown</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="n">options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;use_pySDC&#39;</span><span class="p">,</span> <span class="s1">&#39;use_adaptivity&#39;</span><span class="p">,</span> <span class="s1">&#39;time_parallelism&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;False&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">]</span>

    <span class="n">williamson_5</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorial/doc_step_7_F.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 5.5.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">&lt;no title&gt;</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Robert Speck.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.0.
    </div>
  </body>
</html>