<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>implementations.convergence_controller_classes.adaptivity &#8212; pySDC 5.5.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=2bf1fcf8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=c40552b6" />
    
    <script src="../../../_static/documentation_options.js?v=3005adad"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pySDC 5.5.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">implementations.convergence_controller_classes.adaptivity</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for implementations.convergence_controller_classes.adaptivity</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pySDC.core.convergence_controller</span> <span class="kn">import</span> <span class="n">ConvergenceController</span><span class="p">,</span> <span class="n">Status</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.step_size_limiter</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepSizeLimiter</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="AdaptivityBase">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityBase">[docs]</a>
<span class="k">class</span> <span class="nc">AdaptivityBase</span><span class="p">(</span><span class="n">ConvergenceController</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for convergence controllers that implement adaptivity based on arbitrary local error estimates</span>
<span class="sd">    and update rules.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdaptivityBase.setup">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityBase.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define default parameters here.</span>

<span class="sd">        Default parameters are:</span>
<span class="sd">         - control_order (int): The order relative to other convergence controllers</span>
<span class="sd">         - beta (float): The safety factor</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            params (dict): The params passed for this specific convergence controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            (dict): The updated params dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;control_order&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span>
            <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="kn">from</span> <span class="nn">pySDC.implementations.hooks.log_step_size</span> <span class="kn">import</span> <span class="n">LogStepSize</span>

        <span class="n">controller</span><span class="o">.</span><span class="n">add_hook</span><span class="p">(</span><span class="n">LogStepSize</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.check_convergence</span> <span class="kn">import</span> <span class="n">CheckConvergence</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">communicate_convergence</span> <span class="o">=</span> <span class="n">CheckConvergence</span><span class="o">.</span><span class="n">communicate_convergence</span>

        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)}</span></div>


<div class="viewcode-block" id="AdaptivityBase.dependencies">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityBase.dependencies">[docs]</a>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load step size limiters here, if they are desired.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">step_limiter_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dt_min&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_max&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_slope_min&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_slope_max&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_rel_min_slope&#39;</span><span class="p">]</span>
        <span class="n">available_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">me</span> <span class="k">for</span> <span class="n">me</span> <span class="ow">in</span> <span class="n">step_limiter_keys</span> <span class="k">if</span> <span class="n">me</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">step_limiter_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">available_keys</span><span class="p">}</span>
            <span class="n">controller</span><span class="o">.</span><span class="n">add_convergence_controller</span><span class="p">(</span><span class="n">StepSizeLimiter</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">step_limiter_params</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useMPI</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_MPI_logical_operations</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AdaptivityBase.get_new_step_size">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityBase.get_new_step_size">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine a step size for the next step from an estimate of the local error of the current step.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please implement a rule for updating the step size!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityBase.compute_optimal_step_size">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityBase.compute_optimal_step_size">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_optimal_step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">e_tol</span><span class="p">,</span> <span class="n">e_est</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the optimal step size for the current step based on the order of the scheme.</span>
<span class="sd">        This function can be called from `get_new_step_size` for various implementations of adaptivity, but notably not</span>
<span class="sd">        all! We require to know the order of the error estimate and if we do adaptivity based on the residual, for</span>
<span class="sd">        instance, we do not know that and we can&#39;t use this function.</span>

<span class="sd">        Args:</span>
<span class="sd">            beta (float): Safety factor</span>
<span class="sd">            dt (float): Current step size</span>
<span class="sd">            e_tol (float): The desired tolerance</span>
<span class="sd">            e_est (float): The estimated local error</span>
<span class="sd">            order (int): The order of the local error estimate</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The optimal step size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">e_tol</span> <span class="o">/</span> <span class="n">e_est</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">order</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityBase.get_local_error_estimate">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityBase.get_local_error_estimate">[docs]</a>
    <span class="k">def</span> <span class="nf">get_local_error_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the local error estimate for updating the step size.</span>
<span class="sd">        It does not have to be an error estimate, but could be the residual or something else.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The error estimate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please implement a way to get the local error&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityBase.determine_restart">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityBase.determine_restart">[docs]</a>
    <span class="k">def</span> <span class="nf">determine_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the step wants to be restarted by comparing the estimate of the local error to a preset tolerance</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;=</span> <span class="n">S</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maxiter</span><span class="p">:</span>
            <span class="n">e_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_error_estimate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e_est</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="p">:</span>
                <span class="c1"># see if we try to avoid restarts</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avoid_restarts&#39;</span><span class="p">):</span>
                    <span class="n">more_iter_needed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">iter_to_convergence</span> <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">])</span>
                    <span class="n">k_final</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">iter</span> <span class="o">+</span> <span class="n">more_iter_needed</span>
                    <span class="n">rho</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">contraction_factor</span> <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">])</span>
                    <span class="n">coll_order</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sweep</span><span class="o">.</span><span class="n">coll</span><span class="o">.</span><span class="n">order</span>

                    <span class="k">if</span> <span class="n">rho</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Convergence factor = </span><span class="si">{</span><span class="n">rho</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> &gt; 1 -&gt; restarting&quot;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">k_final</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maxiter</span><span class="p">:</span>
                        <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">more_iter_needed</span><span class="si">}</span><span class="s2"> more iterations needed for convergence -&gt; restart is more efficient&quot;</span><span class="p">,</span> <span class="n">S</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">k_final</span> <span class="o">&gt;</span> <span class="n">coll_order</span><span class="p">:</span>
                        <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">more_iter_needed</span><span class="si">}</span><span class="s2"> more iterations needed for convergence -&gt; restart because collocation problem would be over resolved&quot;</span><span class="p">,</span>
                            <span class="n">S</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">force_continue</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">more_iter_needed</span><span class="si">}</span><span class="s2"> more iterations needed for convergence -&gt; no restart&quot;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restarting: e=</span><span class="si">{</span><span class="n">e_est</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> &gt;= e_tol=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="AdaptivityForConvergedCollocationProblems">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityForConvergedCollocationProblems">[docs]</a>
<span class="k">class</span> <span class="nc">AdaptivityForConvergedCollocationProblems</span><span class="p">(</span><span class="n">AdaptivityBase</span><span class="p">):</span>
<div class="viewcode-block" id="AdaptivityForConvergedCollocationProblems.dependencies">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityForConvergedCollocationProblems.dependencies">[docs]</a>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load interpolation between restarts.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">interpolate_between_restarts</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.interpolate_between_restarts</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">InterpolateBetweenRestarts</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">controller</span><span class="o">.</span><span class="n">add_convergence_controller</span><span class="p">(</span>
                <span class="n">InterpolateBetweenRestarts</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{},</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">interpolate_between_restarts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">convergence_controllers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AdaptivityForConvergedCollocationProblems.get_convergence">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityForConvergedCollocationProblems.get_convergence">[docs]</a>
    <span class="k">def</span> <span class="nf">get_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please implement a way to check if the collocation problem is converged!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityForConvergedCollocationProblems.setup">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityForConvergedCollocationProblems.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a default value for control order to the parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            params (dict): Parameters for the convergence controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Updated parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;restol_rel&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;e_tol_rel&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;restart_at_maxiter&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;restol_min&#39;</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span>
            <span class="s1">&#39;restol_max&#39;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span>
            <span class="s1">&#39;factor_if_not_converged&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
            <span class="s1">&#39;residual_max_tol&#39;</span><span class="p">:</span> <span class="mf">1e9</span><span class="p">,</span>
            <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxiter&#39;</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
            <span class="s1">&#39;interpolate_between_restarts&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;abort_at_growing_residual&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;restol_rel&#39;</span><span class="p">]:</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">][</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">max</span><span class="p">([</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;restol_rel&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;e_tol&#39;</span><span class="p">],</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;restol_min&#39;</span><span class="p">]]),</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;restol_max&#39;</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;e_tol_rel&#39;</span><span class="p">]:</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">][</span><span class="s1">&#39;e_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="nb">max</span><span class="p">([</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;e_tol_rel&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;e_tol&#39;</span><span class="p">],</span> <span class="mf">1e-10</span><span class="p">]),</span> <span class="mf">1e-5</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;restart_at_maxiter&#39;</span><span class="p">]:</span>
            <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxiter&#39;</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">res_last_iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="k">return</span> <span class="n">defaults</span></div>


<div class="viewcode-block" id="AdaptivityForConvergedCollocationProblems.determine_restart">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityForConvergedCollocationProblems.determine_restart">[docs]</a>
    <span class="k">def</span> <span class="nf">determine_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_convergence</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res_last_iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">restart_at_maxiter</span> <span class="ow">and</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">residual</span> <span class="o">&gt;</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">restol</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_restart_upon_nonconvergence</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_error_estimate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="p">:</span>
                <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">time_size</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_last_iter</span> <span class="o">&lt;</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">residual</span>
            <span class="ow">and</span> <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">abort_at_growing_residual</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_restart_upon_nonconvergence</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">residual</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">residual_max_tol</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_restart_upon_nonconvergence</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useMPI</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">communicate_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">res_last_iter</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">residual</span> <span class="o">*</span> <span class="mf">1.0</span></div>


<div class="viewcode-block" id="AdaptivityForConvergedCollocationProblems.trigger_restart_upon_nonconvergence">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityForConvergedCollocationProblems.trigger_restart_upon_nonconvergence">[docs]</a>
    <span class="k">def</span> <span class="nf">trigger_restart_upon_nonconvergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
        <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">force_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">factor_if_not_converged</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Collocation problem not converged. Reducing step size to </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">S</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">interpolate_between_restarts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">skip_interpolation</span> <span class="o">=</span> <span class="kc">True</span></div>
</div>



<div class="viewcode-block" id="Adaptivity">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.Adaptivity">[docs]</a>
<span class="k">class</span> <span class="nc">Adaptivity</span><span class="p">(</span><span class="n">AdaptivityBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to compute time step size adaptively based on embedded error estimate.</span>

<span class="sd">    We have a version working in non-MPI pipelined SDC, but Adaptivity requires you to know the order of the scheme,</span>
<span class="sd">    which you can also know for block-Jacobi, but it works differently and it is only implemented for block</span>
<span class="sd">    Gauss-Seidel so far.</span>

<span class="sd">    There is an option to reduce restarts if continued iterations could yield convergence in fewer iterations than</span>
<span class="sd">    restarting based on an estimate of the contraction factor.</span>
<span class="sd">    Since often only one or two more iterations suffice, this can boost efficiency of adaptivity significantly.</span>
<span class="sd">    Notice that the computed step size is not effected.</span>
<span class="sd">    Be aware that this does not work when Hot Rod is enabled, since that requires us to know the order of the scheme in</span>
<span class="sd">    more detail. Since we reset to the second to last sweep before moving on, we cannot continue to iterate.</span>
<span class="sd">    Set the reduced restart up by setting a boolean value for &quot;avoid_restarts&quot; in the parameters for the convergence</span>
<span class="sd">    controller.</span>
<span class="sd">    The behaviour in multi-step SDC is not well studied and it is unclear if anything useful happens there.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Adaptivity.setup">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.Adaptivity.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define default parameters here.</span>

<span class="sd">        Default parameters are:</span>
<span class="sd">         - control_order (int): The order relative to other convergence controllers</span>
<span class="sd">         - beta (float): The safety factor</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            params (dict): The params passed for this specific convergence controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            (dict): The updated params dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;embedded_error_flavor&quot;</span><span class="p">:</span> <span class="s1">&#39;standard&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)}</span></div>


<div class="viewcode-block" id="Adaptivity.dependencies">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.Adaptivity.dependencies">[docs]</a>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the embedded error estimator.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.estimate_embedded_error</span> <span class="kn">import</span> <span class="n">EstimateEmbeddedError</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">controller</span><span class="o">.</span><span class="n">add_convergence_controller</span><span class="p">(</span>
            <span class="n">EstimateEmbeddedError</span><span class="o">.</span><span class="n">get_implementation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">embedded_error_flavor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useMPI</span><span class="p">),</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># load contraction factor estimator if necessary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avoid_restarts&#39;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.estimate_contraction_factor</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">EstimateContractionFactor</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;e_tol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="p">}</span>
            <span class="n">controller</span><span class="o">.</span><span class="n">add_convergence_controller</span><span class="p">(</span><span class="n">EstimateContractionFactor</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Adaptivity.check_parameters">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.Adaptivity.check_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">check_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether parameters are compatible with whatever assumptions went into the step size functions etc.</span>
<span class="sd">        For adaptivity, we need to know the order of the scheme.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            params (dict): The params passed for this specific convergence controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the parameters are compatible</span>
<span class="sd">            str: The error message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">[</span><span class="s2">&quot;level_params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restol&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;Adaptivity needs constant order in time and hence restol in the step parameters has to be </span><span class="se">\</span>
<span class="s2">smaller than 0!&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">controller</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">mssdc_jac</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;Adaptivity needs the same order on all steps, please activate Gauss-Seidel multistep mode!&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;e_tol&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;Adaptivity needs a local tolerance! Please pass `e_tol` to the parameters for this convergence controller!&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="Adaptivity.get_new_step_size">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.Adaptivity.get_new_step_size">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine a step size for the next step from an embedded estimate of the local error of the current step.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if we performed the desired amount of sweeps</span>
        <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">iter</span> <span class="o">==</span> <span class="n">S</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maxiter</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># compute next step size</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">iter</span>  <span class="c1"># embedded error estimate is same order as time marching</span>

            <span class="n">e_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_error_estimate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_optimal_step_size</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="p">,</span> <span class="n">e_est</span><span class="p">,</span> <span class="n">order</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjusting step size from </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Adaptivity.get_local_error_estimate">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.Adaptivity.get_local_error_estimate">[docs]</a>
    <span class="k">def</span> <span class="nf">get_local_error_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the embedded error estimate of the finest level of the step.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Embedded error estimate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">error_embedded_estimate</span></div>
</div>



<div class="viewcode-block" id="AdaptivityRK">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityRK">[docs]</a>
<span class="k">class</span> <span class="nc">AdaptivityRK</span><span class="p">(</span><span class="n">Adaptivity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adaptivity for Runge-Kutta methods. Basically, we need to change the order in the step size update</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdaptivityRK.setup">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityRK.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;update_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;update_order&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_update_order</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)}</span></div>


<div class="viewcode-block" id="AdaptivityRK.get_new_step_size">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityRK.get_new_step_size">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine a step size for the next step from an embedded estimate of the local error of the current step.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if we performed the desired amount of sweeps</span>
        <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">iter</span> <span class="o">==</span> <span class="n">S</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maxiter</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># compute next step size</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update_order</span>
            <span class="n">e_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_error_estimate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_optimal_step_size</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="p">,</span> <span class="n">e_est</span><span class="p">,</span> <span class="n">order</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjusting step size from </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="AdaptivityResidual">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityResidual">[docs]</a>
<span class="k">class</span> <span class="nc">AdaptivityResidual</span><span class="p">(</span><span class="n">AdaptivityBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do adaptivity based on residual.</span>

<span class="sd">    Since we don&#39;t know a correlation between the residual and the error (for nonlinear problems), we employ a simpler</span>
<span class="sd">    rule to update the step size. Instead of giving a local tolerance that we try to hit as closely as possible, we set</span>
<span class="sd">    two thresholds for the residual. When we exceed the upper one, we reduce the step size by a factor of 2 and if the</span>
<span class="sd">    residual falls below the lower threshold, we double the step size.</span>
<span class="sd">    Please setup these parameters as &quot;e_tol&quot; and &quot;e_tol_low&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdaptivityResidual.setup">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityResidual.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define default parameters here.</span>

<span class="sd">        Default parameters are:</span>
<span class="sd">         - control_order (int): The order relative to other convergence controllers</span>
<span class="sd">         - e_tol_low (float): Lower absolute threshold for the residual</span>
<span class="sd">         - e_tol (float): Upper absolute threshold for the residual</span>
<span class="sd">         - use_restol (bool): Restart if the residual tolerance was not reached</span>
<span class="sd">         - max_restarts: Override maximum number of restarts</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            params (dict): The params passed for this specific convergence controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            (dict): The updated params dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;control_order&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span>
            <span class="s2">&quot;e_tol_low&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;e_tol&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
            <span class="s2">&quot;use_restol&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;max_restarts&quot;</span><span class="p">:</span> <span class="mi">99</span> <span class="k">if</span> <span class="s2">&quot;e_tol_low&quot;</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;allowed_modifications&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;increase&#39;</span><span class="p">,</span> <span class="s1">&#39;decrease&#39;</span><span class="p">],</span>  <span class="c1"># what we are allowed to do with the step size</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">}</span></div>


<div class="viewcode-block" id="AdaptivityResidual.setup_status_variables">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityResidual.setup_status_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_status_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change maximum number of allowed restarts here.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>

<span class="sd">        Reutrns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.basic_restarting</span> <span class="kn">import</span> <span class="n">BasicRestarting</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_restarts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conv_controllers</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">convergence_controllers</span>
            <span class="n">restart_cont</span> <span class="o">=</span> <span class="p">[</span><span class="n">me</span> <span class="k">for</span> <span class="n">me</span> <span class="ow">in</span> <span class="n">conv_controllers</span> <span class="k">if</span> <span class="n">BasicRestarting</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">(</span><span class="n">me</span><span class="p">)</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">restart_cont</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please implement override of maximum number of restarts!&quot;</span><span class="p">)</span>

            <span class="n">restart_cont</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_restarts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_restarts</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AdaptivityResidual.check_parameters">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityResidual.check_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">check_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether parameters are compatible with whatever assumptions went into the step size functions etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            params (dict): The params passed for this specific convergence controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the parameters are compatible</span>
<span class="sd">            str: The error message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">controller</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">mssdc_jac</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;Adaptivity needs the same order on all steps, please activate Gauss-Seidel multistep mode!&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="AdaptivityResidual.get_new_step_size">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityResidual.get_new_step_size">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine a step size for the next step.</span>
<span class="sd">        If we exceed the absolute tolerance of the residual in either direction, we either double or halve the step</span>
<span class="sd">        size.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if we performed the desired amount of sweeps</span>
        <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">iter</span> <span class="o">==</span> <span class="n">S</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maxiter</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_error_estimate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

            <span class="n">dt_planned</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="k">if</span> <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">res</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span> <span class="ow">or</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">restol</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">use_restol</span><span class="p">)</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;decrease&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">allowed_modifications</span><span class="p">:</span>
                <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">dt_planned</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjusting step size from </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">res</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol_low</span> <span class="ow">and</span> <span class="s1">&#39;increase&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">allowed_modifications</span><span class="p">:</span>
                <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">dt_planned</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjusting step size from </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AdaptivityResidual.get_local_error_estimate">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityResidual.get_local_error_estimate">[docs]</a>
    <span class="k">def</span> <span class="nf">get_local_error_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the residual of the finest level of the step.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Embedded error estimate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">residual</span></div>
</div>



<div class="viewcode-block" id="AdaptivityCollocation">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation">[docs]</a>
<span class="k">class</span> <span class="nc">AdaptivityCollocation</span><span class="p">(</span><span class="n">AdaptivityForConvergedCollocationProblems</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Control the step size via a collocation based estimate of the local error.</span>
<span class="sd">    The error estimate works by subtracting two solutions to collocation problems with different order. You can</span>
<span class="sd">    interpolate between collocation methods as much as you want but the adaptive step size selection will always be</span>
<span class="sd">    based on the last switch of quadrature.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdaptivityCollocation.setup">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a default value for control order to the parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            params (dict): Parameters for the convergence controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Updated parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;adaptive_coll_params&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;num_colls&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="s2">&quot;control_order&quot;</span><span class="p">:</span> <span class="mi">220</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;adaptive_coll_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;adaptive_coll_params&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;num_colls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;num_colls&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;adaptive_coll_params&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">])])</span>

        <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;restart_at_maxiter&#39;</span><span class="p">]:</span>
            <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxiter&#39;</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span> <span class="o">*</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;num_colls&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">defaults</span></div>


<div class="viewcode-block" id="AdaptivityCollocation.setup_status_variables">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.setup_status_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_status_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="p">([</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="AdaptivityCollocation.reset_status_variables">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.reset_status_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_status_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_status_variables</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityCollocation.dependencies">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.dependencies">[docs]</a>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the `EstimateEmbeddedErrorCollocation` convergence controller to estimate the local error by switching</span>
<span class="sd">        between collocation problems between iterations.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.estimate_embedded_error</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">EstimateEmbeddedErrorCollocation</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;adaptive_coll_params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">adaptive_coll_params</span><span class="p">}</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">add_convergence_controller</span><span class="p">(</span>
            <span class="n">EstimateEmbeddedErrorCollocation</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityCollocation.get_convergence">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.get_convergence">[docs]</a>
    <span class="k">def</span> <span class="nf">get_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_colls</span></div>


<div class="viewcode-block" id="AdaptivityCollocation.get_local_error_estimate">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.get_local_error_estimate">[docs]</a>
    <span class="k">def</span> <span class="nf">get_local_error_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the collocation based embedded error estimate.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Embedded error estimate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span></div>


<div class="viewcode-block" id="AdaptivityCollocation.post_iteration_processing">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.post_iteration_processing">[docs]</a>
    <span class="k">def</span> <span class="nf">post_iteration_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the error estimate and its order if available.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller.controller): The controller</span>
<span class="sd">            step (pySDC.Step.step): The current step</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="n">lvl</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">error</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lvl</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">error_embedded_estimate_collocation</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">order</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lvl</span><span class="o">.</span><span class="n">sweep</span><span class="o">.</span><span class="n">coll</span><span class="o">.</span><span class="n">order</span><span class="p">]</span></div>


<div class="viewcode-block" id="AdaptivityCollocation.get_new_step_size">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.get_new_step_size">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_colls</span><span class="p">:</span>
            <span class="n">lvl</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># compute next step size</span>
            <span class="n">order</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">::])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>  <span class="c1"># local order of less accurate of the last two collocation problems</span>
            <span class="n">e_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_error_estimate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

            <span class="n">lvl</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_optimal_step_size</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">lvl</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="p">,</span> <span class="n">e_est</span><span class="p">,</span> <span class="n">order</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjusting step size from </span><span class="si">{</span><span class="n">lvl</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">lvl</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityCollocation.determine_restart">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.determine_restart">[docs]</a>
    <span class="k">def</span> <span class="nf">determine_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the step wants to be restarted by comparing the estimate of the local error to a preset tolerance</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_colls</span><span class="p">:</span>
            <span class="n">e_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_error_estimate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e_est</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="p">:</span>
                <span class="n">S</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restarting: e=</span><span class="si">{</span><span class="n">e_est</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> &gt;= e_tol=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityCollocation.check_parameters">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityCollocation.check_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">check_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether parameters are compatible with whatever assumptions went into the step size functions etc.</span>
<span class="sd">        For adaptivity, we need to know the order of the scheme.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            params (dict): The params passed for this specific convergence controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the parameters are compatible</span>
<span class="sd">            str: The error message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;e_tol&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;Adaptivity needs a local tolerance! Please pass `e_tol` to the parameters for this convergence controller!&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span></div>
</div>



<div class="viewcode-block" id="AdaptivityExtrapolationWithinQ">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityExtrapolationWithinQ">[docs]</a>
<span class="k">class</span> <span class="nc">AdaptivityExtrapolationWithinQ</span><span class="p">(</span><span class="n">AdaptivityForConvergedCollocationProblems</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to compute time step size adaptively based on error estimate obtained from extrapolation within the quadrature</span>
<span class="sd">    nodes.</span>

<span class="sd">    This error estimate depends on solving the collocation problem exactly, so make sure you set a sufficient stopping criterion.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdaptivityExtrapolationWithinQ.setup">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityExtrapolationWithinQ.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.check_convergence</span> <span class="kn">import</span> <span class="n">CheckConvergence</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;high_Taylor_order&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">params</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_convergence</span> <span class="o">=</span> <span class="n">CheckConvergence</span><span class="o">.</span><span class="n">check_convergence</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)}</span></div>


<div class="viewcode-block" id="AdaptivityExtrapolationWithinQ.get_convergence">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityExtrapolationWithinQ.get_convergence">[docs]</a>
    <span class="k">def</span> <span class="nf">get_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_convergence</span><span class="p">(</span><span class="n">S</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityExtrapolationWithinQ.dependencies">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityExtrapolationWithinQ.dependencies">[docs]</a>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the error estimator.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.estimate_extrapolation_error</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">EstimateExtrapolationErrorWithinQ</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">controller</span><span class="o">.</span><span class="n">add_convergence_controller</span><span class="p">(</span>
            <span class="n">EstimateExtrapolationErrorWithinQ</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;high_Taylor_order&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">high_Taylor_order</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AdaptivityExtrapolationWithinQ.get_new_step_size">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityExtrapolationWithinQ.get_new_step_size">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine a step size for the next step from the error estimate.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_convergence</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># compute next step size</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">sweep</span><span class="o">.</span><span class="n">coll</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">high_Taylor_order</span> <span class="k">else</span> <span class="n">L</span><span class="o">.</span><span class="n">sweep</span><span class="o">.</span><span class="n">coll</span><span class="o">.</span><span class="n">num_nodes</span>

            <span class="n">e_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_error_estimate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_optimal_step_size</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="p">,</span> <span class="n">e_est</span><span class="p">,</span> <span class="n">order</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Error target: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">, error estimate: </span><span class="si">{</span><span class="n">e_est</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">, update_order: </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">S</span><span class="p">,</span>
                <span class="n">level</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjusting step size from </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AdaptivityExtrapolationWithinQ.get_local_error_estimate">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityExtrapolationWithinQ.get_local_error_estimate">[docs]</a>
    <span class="k">def</span> <span class="nf">get_local_error_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the embedded error estimate of the finest level of the step.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Embedded error estimate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">error_extrapolation_estimate</span></div>
</div>



<div class="viewcode-block" id="AdaptivityPolynomialError">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityPolynomialError">[docs]</a>
<span class="k">class</span> <span class="nc">AdaptivityPolynomialError</span><span class="p">(</span><span class="n">AdaptivityForConvergedCollocationProblems</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to compute time step size adaptively based on error estimate obtained from interpolation within the quadrature</span>
<span class="sd">    nodes.</span>

<span class="sd">    This error estimate depends on solving the collocation problem exactly, so make sure you set a sufficient stopping criterion.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AdaptivityPolynomialError.setup">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityPolynomialError.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.check_convergence</span> <span class="kn">import</span> <span class="n">CheckConvergence</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;control_order&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="o">**</span><span class="n">params</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_convergence</span> <span class="o">=</span> <span class="n">CheckConvergence</span><span class="o">.</span><span class="n">check_convergence</span>
        <span class="k">return</span> <span class="n">defaults</span></div>


<div class="viewcode-block" id="AdaptivityPolynomialError.get_convergence">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityPolynomialError.get_convergence">[docs]</a>
    <span class="k">def</span> <span class="nf">get_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_convergence</span><span class="p">(</span><span class="n">S</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdaptivityPolynomialError.dependencies">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityPolynomialError.dependencies">[docs]</a>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the error estimator.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            description (dict): The description object used to instantiate the controller</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pySDC.implementations.convergence_controller_classes.estimate_polynomial_error</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">EstimatePolynomialError</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">controller</span><span class="o">.</span><span class="n">add_convergence_controller</span><span class="p">(</span>
            <span class="n">EstimatePolynomialError</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AdaptivityPolynomialError.get_new_step_size">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityPolynomialError.get_new_step_size">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_step_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine a step size for the next step from the error estimate.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_convergence</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># compute next step size</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">order_embedded_estimate</span>

            <span class="n">e_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_error_estimate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_optimal_step_size</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="p">,</span> <span class="n">e_est</span><span class="p">,</span> <span class="n">order</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Error target: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">e_tol</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">, error estimate: </span><span class="si">{</span><span class="n">e_est</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">, update_order: </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">S</span><span class="p">,</span>
                <span class="n">level</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjusting step size from </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dt</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">dt_new</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AdaptivityPolynomialError.get_local_error_estimate">
<a class="viewcode-back" href="../../../pySDC/implementations.convergence_controller_classes.adaptivity.html#implementations.convergence_controller_classes.adaptivity.AdaptivityPolynomialError.get_local_error_estimate">[docs]</a>
    <span class="k">def</span> <span class="nf">get_local_error_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the embedded error estimate of the finest level of the step.</span>

<span class="sd">        Args:</span>
<span class="sd">            controller (pySDC.Controller): The controller</span>
<span class="sd">            S (pySDC.Step): The current step</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Embedded error estimate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">error_embedded_estimate</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pySDC 5.5.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">implementations.convergence_controller_classes.adaptivity</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Robert Speck.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>